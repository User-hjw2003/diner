<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åƒç´ é£Ÿå ‚ Â· äº‘ç‚¹é¤ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* ========== åƒç´ é£æ ¼å…¨å±€æ ·å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', 'DotGothic16', monospace;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #d32f2f;
            --primary-dark: #b71c1c;
            --bg: #0a0a0a;
            --surface: #1a1a1a;
            --surface-light: #222;
            --text: #ffffff;
            --text-secondary: #ccc;
            --text-muted: #aaa;
            --success: #2e7d32;
            --success-light: #4caf50;
            --warning: #ff6d00;
            --error: #c62828;
            --border-pixel: 4px solid #fff;
            --grid: rgba(255,255,255,0.03);
            --scanline: rgba(0,255,0,0.05);
        }

        html, body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            position: relative;
            touch-action: pan-y; /* ä»…å…è®¸å‚ç›´æ»šåŠ¨ï¼Œé˜²æ­¢ç¼©æ”¾ */
            overflow-x: hidden;
            width: 100%;
        }

        /* ç½‘æ ¼èƒŒæ™¯ + æ‰«æçº¿ */
        body {
            background-image: 
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 24px 24px;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent 50%, var(--scanline) 51%);
            background-size: 100% 6px;
            pointer-events: none;
            z-index: 9998;
            opacity: 0.25;
            animation: scan 12s linear infinite;
        }

        @keyframes scan { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

        /* ===== åƒç´ è¾¹æ¡†ç”Ÿæˆå™¨ ===== */
        .pixel-border {
            border: 4px solid transparent;
            border-image: url('data:image/svg+xml;utf8,<svg width="8" height="8" xmlns="http://www.w3.org/2000/svg"><path d="M3 1h1v1h-1zM4 1h1v1h-1zM2 2h1v1h-1zM5 2h1v1h-1zM1 3h1v1h-1zM6 3h1v1h-1zM1 4h1v1h-1zM6 4h1v1h-1zM2 5h1v1h-1zM5 5h1v1h-1zM3 6h1v1h-1zM4 6h1v1h-1z" fill="%23d32f2f"/></svg>') 2 stretch;
            background: var(--surface);
        }

        .pixel-border-white {
            border: 4px solid transparent;
            border-image: url('data:image/svg+xml;utf8,<svg width="8" height="8" xmlns="http://www.w3.org/2000/svg"><path d="M3 1h1v1h-1zM4 1h1v1h-1zM2 2h1v1h-1zM5 2h1v1h-1zM1 3h1v1h-1zM6 3h1v1h-1zM1 4h1v1h-1zM6 4h1v1h-1zM2 5h1v1h-1zM5 5h1v1h-1zM3 6h1v1h-1zM4 6h1v1h-1z" fill="white"/></svg>') 2 stretch;
            background: var(--surface-light);
        }

        /* ===== åƒç´ æŒ‰é’® ===== */
        .pixel-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            position: relative;
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.05s linear;
            white-space: nowrap;
            gap: 6px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        .pixel-btn:active {
            transform: translate(3px, 3px);
        }
        .pixel-btn::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 0;
            width: 100%;
            height: 4px;
            background: white;
        }
        .pixel-btn::after {
            content: '';
            position: absolute;
            left: -4px;
            top: 0;
            width: 4px;
            height: 100%;
            background: white;
        }
        .pixel-btn.secondary { background: #2a2a2a; }
        .pixel-btn.success { background: var(--success); }
        .pixel-btn.warning { background: var(--warning); }
        .pixel-btn.active { background: var(--primary-dark); }
        .pixel-btn:disabled {
            opacity: 0.5;
            transform: none;
            pointer-events: none;
        }

        /* æ ‡é¢˜ */
        h1, h2, h3 {
            color: var(--primary);
            text-shadow: 3px 3px 0 #000;
            letter-spacing: 3px;
            margin-bottom: 20px;
        }
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.8rem; border-bottom: 4px solid var(--primary); display: inline-block; padding-bottom: 8px; }

        /* å¸ƒå±€å®¹å™¨ */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 20px 16px;
            width: 100%;
        }

        /* ===== å¤´éƒ¨ ===== */
        header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo i { font-size: 48px; color: var(--primary); }
        .header-controls {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        @media (max-width: 768px) {
            header { flex-direction: column; }
            .logo { width: 100%; justify-content: center; margin-bottom: 16px; }
            .header-controls { width: 100%; justify-content: center; }
            .header-controls .pixel-btn { 
                min-width: 0; 
                flex: 1; 
                padding: 10px 8px;
                font-size: 14px;
                white-space: nowrap;
            }
        }

        /* ===== é¡µé¢åˆ‡æ¢ ===== */
        .page { display: none; animation: fade 0.2s; }
        .page.active { display: block; }
        @keyframes fade { from { opacity: 0.5; } to { opacity: 1; } }

        /* ===== èœå•åˆ†ç±» ===== */
        .menu-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: flex-start;
        }
        .category-btn {
            padding: 10px 20px;
            background: #1e1e1e;
            color: white;
            border: 2px solid #444;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.1s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .category-btn.active {
            background: var(--primary);
            border-color: white;
        }

        /* ===== èœå•ç½‘æ ¼ ===== */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        .menu-item {
            background: var(--surface);
            padding: 16px;
            transition: transform 0.2s;
        }
        .menu-item:hover { transform: translateY(-4px); }
        .item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border: 3px solid var(--primary);
            background: #2a2a2a;
            display: block;
        }
        .item-name { font-size: 1.4rem; color: var(--primary); margin: 12px 0 8px; }
        .item-desc { color: var(--text-muted); font-size: 14px; margin-bottom: 12px; line-height: 1.4; min-height: 42px; }
        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-price { font-size: 1.6rem; font-weight: bold; color: white; }
        .add-to-cart {
            background: #333;
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
        }

        /* ===== äºŒç»´ç åŒºåŸŸ ===== */
        .qrcode-section {
            background: var(--surface);
            padding: 30px;
            margin-top: 30px;
        }
        .qrcode-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 40px;
        }
        .qrcode-display {
            background: white;
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 240px;
            height: 240px;
        }
        .qrcode-display img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .qrcode-info {
            max-width: 400px;
            text-align: center;
        }
        .url-display {
            background: #222;
            padding: 12px;
            margin: 16px 0;
            border-left: 6px solid var(--primary);
            word-break: break-all;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .qrcode-actions {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }
        @media (max-width: 480px) {
            .qrcode-wrapper { flex-direction: column; }
            .qrcode-display { width: 200px; height: 200px; }
            .qrcode-actions { flex-wrap: wrap; }
            .qrcode-actions .pixel-btn { min-width: 140px; }
        }

        /* ===== è´­ç‰©è½¦ ===== */
        .cart-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 70px;
            height: 70px;
            border-radius: 0;
            background: var(--primary);
            color: white;
            border: 4px solid white;
            font-size: 28px;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error);
            color: white;
            border-radius: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 2px solid white;
        }

        .cart-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            max-width: 460px;
            background: var(--surface);
            border-top: 6px solid var(--primary);
            border-left: 6px solid var(--primary);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
            z-index: 1000;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .cart-panel.open {
            transform: translateX(0);
        }
        body.cart-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .cart-header {
            background: var(--primary);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-header h3 { margin: 0; color: white; text-shadow: none; border: none; }
        .cart-tabs {
            display: flex;
            background: #222;
        }
        .cart-tab {
            flex: 1;
            padding: 14px;
            background: #2a2a2a;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 15px;
        }
        .cart-tab.active {
            background: var(--primary);
            font-weight: bold;
        }

        .cart-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .cart-tab-content { display: none; }
        .cart-tab-content.active { display: block; }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 2px solid #333;
        }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: bold; color: var(--primary); }
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cart-qty-btn {
            width: 40px;
            height: 40px;
            background: black !important;
            color: white !important;
            border: 2px solid white !important;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            touch-action: none;
        }
        .cart-item-qty {
            min-width: 40px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .cart-item-remove {
            background: var(--error) !important;
            color: white !important;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 8px;
            border: 2px solid white !important;
        }

        .cart-total {
            padding: 16px;
            background: #222;
            display: flex;
            justify-content: space-between;
            font-size: 1.4rem;
            font-weight: bold;
            margin-top: 20px;
        }

        /* æ‰‹æœºå·ç è¾“å…¥æ¡†éªŒè¯æ•ˆæœ */
        .phone-input {
            width: 100%;
            padding: 14px;
            background: #222;
            border: 3px solid #555;
            color: white;
            font-size: 16px;
            margin: 10px 0;
            transition: all 0.15s;
        }
        .phone-valid {
            border-color: var(--success-light) !important;
            background: rgba(46, 125, 50, 0.15);
        }
        .phone-invalid {
            border-color: var(--error) !important;
            background: rgba(198, 40, 40, 0.15);
        }

        /* ===== è®¢å•å†å² ===== */
        .order-history-item {
            background: #1a1a1a;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 6px solid var(--primary);
        }

        /* ===== ç®¡ç†åå° ===== */
        .admin-login-box {
            max-width: 420px;
            margin: 60px auto;
            padding: 40px;
            text-align: center;
        }
        .admin-panel { display: none; }

        .admin-controls-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .admin-controls-row .pixel-btn {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 12px 16px;
        }
        @media (max-width: 640px) {
            .admin-controls-row .pixel-btn { min-width: 100px; padding: 10px 8px; font-size: 13px; }
        }

        /* è®¢å•åˆ—è¡¨æŒ‰é’®åŒè¡Œ */
        .orders-toolbar {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .orders-toolbar span {
            white-space: nowrap;
            color: var(--text-muted);
            font-size: 15px;
        }

        .order-item {
            background: #1a1a1a;
            padding: 18px;
            margin-bottom: 20px;
        }
        .order-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
        }
        .order-number {
            color: white !important;
            font-size: 1.2rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 260px;
        }
        .customer-phone-row {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 1rem;
            margin-top: 6px;
            flex-wrap: nowrap;
        }
        .call-btn {
            background: #2196f3;
            color: white;
            padding: 4px 12px;
            border: none;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            cursor: pointer;
            border: 2px solid white;
        }

        .order-actions {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            margin-top: 16px;
        }
        .order-actions .pixel-btn {
            flex: 1;
            min-width: 70px;
            padding: 8px 12px;
            font-size: 13px;
            white-space: nowrap;
        }

        /* æ•°æ®åº“é…ç½®æŒ‰é’®è¡Œ */
        .config-buttons-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 12px;
            margin-top: 24px;
            overflow-x: auto;
        }

        /* ===== è¿æ¥çŠ¶æ€ ===== */
        .connection-badge {
            position: fixed;
            top: 12px;
            right: 16px;
            padding: 8px 16px;
            background: var(--success);
            color: white;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 9999;
            border: 2px solid white;
        }
        .connection-badge.offline { background: var(--error); }
        .connection-badge.syncing { background: var(--warning); animation: blink 1s infinite; }

        /* ===== é€šçŸ¥ ===== */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 16px 24px;
            background: var(--primary);
            color: white;
            border: 4px solid white;
            z-index: 10001;
            display: none;
            max-width: 360px;
        }

        /* å·¥å…·ç±» */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 0; animation: spin 0.8s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .no-scroll { overflow: hidden; position: fixed; width: 100%; height: 100%; }
        .empty-message { text-align: center; padding: 40px; color: var(--text-muted); }
        .order-status { background: var(--primary); padding: 6px 12px; color: white; }
        .order-status.processed { background: var(--success); }
        .blink { animation: blink 1.5s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.6;} }
    </style>
</head>
<body>
    <!-- å®æ—¶è¿æ¥çŠ¶æ€ -->
    <div id="connectionStatus" class="connection-badge online">
        <i class="fas fa-wifi"></i>
        <span>å®æ—¶è¿æ¥ Â· äº‘ç«¯</span>
    </div>

    <!-- æ–°è®¢å•é€šçŸ¥æµ®å±‚ -->
    <div id="newOrderNotify" class="notification" style="display: none; top: 140px;">
        <i class="fas fa-bell"></i> <span id="newOrderMsg">æœ‰æ–°è®¢å•ï¼</span>
    </div>

    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="globalLoading" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000; flex-direction: column; align-items: center; justify-content: center;">
        <div class="loading" style="width: 50px; height: 50px;"></div>
        <p id="loadingText" style="color: var(--primary); margin-top: 20px; font-size: 1.4rem;">åŠ è½½ä¸­...</p>
    </div>

    <div class="container">
        <!-- æ ‡é¢˜åŒº -->
        <div style="text-align: center; margin-bottom: 10px;">
            <h1><i class="fas fa-cloud-upload-alt"></i> äº‘ç‚¹é¤Â·åƒç´ é£Ÿå ‚</h1>
        </div>

        <header>
            <div class="logo">
                <i class="fas fa-utensil-spoon"></i>
                <div>
                    <h2 style="margin:0; border: none;">åƒç´ é£Ÿå ‚</h2>
                    <p style="color: #aaa;">å®æ—¶åŒæ­¥ Â· å³ç‚¹å³åš</p>
                </div>
            </div>
            <div class="header-controls">
                <button id="btnMenu" class="pixel-btn active"><i class="fas fa-book"></i> é¡¾å®¢ç‚¹é¤</button>
                <button id="btnAdmin" class="pixel-btn secondary"><i class="fas fa-cog"></i> ç®¡ç†åå°</button>
                <button id="btnSync" class="pixel-btn success"><i class="fas fa-sync-alt"></i> åŒæ­¥</button>
            </div>
        </header>

        <!-- ========== é¡¾å®¢ç‚¹é¤é¡µé¢ ========== -->
        <div id="pageMenu" class="page active">
            <h2><i class="fas fa-utensils"></i> èœå• Â· äº‘åŒæ­¥</h2>
            <div class="menu-categories">
                <button class="category-btn active" data-cat="all">å…¨éƒ¨</button>
                <button class="category-btn" data-cat="main">ä¸»èœ</button>
                <button class="category-btn" data-cat="side">å°é£Ÿ</button>
                <button class="category-btn" data-cat="drink">é¥®å“</button>
                <button class="category-btn" data-cat="dessert">ç”œç‚¹</button>
            </div>

            <!-- èœå“ç½‘æ ¼ -->
            <div id="menuGrid" class="menu-grid">
                <!-- JSåŠ¨æ€æ¸²æŸ“ -->
            </div>

            <!-- æ‰«ç ç‚¹é¤ -->
            <div class="qrcode-section pixel-border">
                <h3><i class="fas fa-qrcode"></i> æ‰‹æœºæ‰«ç ç‚¹é¤</h3>
                <div class="qrcode-wrapper">
                    <div class="qrcode-display pixel-border-white" id="customerQrContainer"></div>
                    <div class="qrcode-info">
                        <h4>äº‘ç‚¹é¤ä¼˜åŠ¿</h4>
                        <ul style="list-style: none; text-align: left; color: #ccc;">
                            <li><i class="fas fa-cloud"></i> æ•°æ®å®æ—¶äº‘ç«¯åŒæ­¥</li>
                            <li><i class="fas fa-bolt"></i> è®¢å•ç§’æ¨å¨æˆ¿</li>
                            <li><i class="fas fa-sync"></i> å¤šè®¾å¤‡ä¸€è‡´</li>
                        </ul>
                        <div class="url-display" id="orderUrlDisplay">
                            ç‚¹é¤ç½‘å€: https://vtwhilxqztqmetorntid.supabase.co
                        </div>
                    </div>
                </div>
                <div class="qrcode-actions">
                    <button id="refreshQrBtn" class="pixel-btn secondary"><i class="fas fa-sync-alt"></i> åˆ·æ–°äºŒç»´ç </button>
                    <button id="saveQrBtn" class="pixel-btn secondary"><i class="fas fa-download"></i> ä¿å­˜äºŒç»´ç </button>
                </div>
            </div>
        </div>

        <!-- ========== ç®¡ç†åå°é¡µé¢ ========== -->
        <div id="pageAdmin" class="page">
            <!-- ç™»å½•æ¡† -->
            <div id="adminLoginBox" class="admin-login-box pixel-border">
                <h2><i class="fas fa-lock"></i> ç®¡ç†å‘˜</h2>
                <p style="margin: 20px 0;">å¯†ç : admin123</p>
                <input type="password" id="adminPasswordInput" class="phone-input" placeholder="è¾“å…¥å¯†ç " style="text-align: center;">
                <button id="adminLoginBtn" class="pixel-btn" style="width: 100%; margin-top: 20px;">ç™»å½•</button>
            </div>

            <!-- ç®¡ç†é¢æ¿ (ç™»å½•åå¯è§) -->
            <div id="adminPanel" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2><i class="fas fa-cogs"></i> äº‘ç«¯ç®¡ç†</h2>
                    <span style="color: #4caf50; background: #1a3a1a; padding: 6px 12px;">å®æ—¶åœ¨çº¿</span>
                </div>

                <!-- é¡¶æ æŒ‰é’®ç»„ (å…¨éƒ¨åœ¨åŒä¸€è¡Œ) -->
                <div class="admin-controls-row">
                    <button id="adminAddItemBtn" class="pixel-btn active"><i class="fas fa-plus"></i> æ–°å¢èœå“</button>
                    <button id="adminViewOrdersBtn" class="pixel-btn secondary"><i class="fas fa-list"></i> æŸ¥çœ‹è®¢å•</button>
                    <button id="adminQrBtn" class="pixel-btn secondary"><i class="fas fa-qrcode"></i> ç”ŸæˆäºŒç»´ç </button>
                    <button id="adminConfigBtn" class="pixel-btn secondary"><i class="fas fa-database"></i> æ•°æ®åº“é…ç½®</button>
                    <button id="adminLogoutBtn" class="pixel-btn warning"><i class="fas fa-sign-out-alt"></i> é€€å‡º</button>
                </div>

                <!-- ===== èœå“è¡¨å• ===== -->
                <div id="adminItemForm" class="pixel-border" style="padding: 24px; margin-bottom: 30px;">
                    <h3 id="formTitle">æ–°å¢èœå“</h3>
                    <form id="menuItemForm">
                        <input type="hidden" id="itemIdField">
                        <div style="margin-bottom: 16px;">
                            <label style="color: var(--primary);">èœå</label>
                            <input type="text" id="itemName" class="phone-input" required>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="color: var(--primary);">åˆ†ç±»</label>
                            <select id="itemCategory" class="phone-input">
                                <option value="main">ä¸»èœ</option>
                                <option value="side">å°é£Ÿ</option>
                                <option value="drink">é¥®å“</option>
                                <option value="dessert">ç”œç‚¹</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="color: var(--primary);">ä»·æ ¼</label>
                            <input type="number" id="itemPrice" step="0.01" min="0" class="phone-input" required>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="color: var(--primary);">æè¿°</label>
                            <textarea id="itemDesc" class="phone-input" rows="2"></textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="color: var(--primary);">å›¾ç‰‡</label>
                            <div style="display: flex; gap: 10px; flex-wrap: nowrap;">
                                <button type="button" id="uploadLocalBtn" class="pixel-btn secondary"><i class="fas fa-upload"></i> æœ¬åœ°ä¸Šä¼ </button>
                                <button type="button" id="useUrlBtn" class="pixel-btn secondary"><i class="fas fa-link"></i> ç½‘ç»œå›¾ç‰‡</button>
                            </div>
                            <input type="file" id="localImageInput" accept="image/*" style="display: none;">
                            <input type="text" id="imageUrlInput" class="phone-input" placeholder="http://..." style="display: none; margin-top: 10px;">
                            <img id="imagePreview" class="item-image" style="display: none; margin-top: 12px; height: 160px; object-fit: contain;">
                        </div>
                        <div style="display: flex; gap: 16px;">
                            <button type="submit" class="pixel-btn success" style="flex:2;">ä¿å­˜åˆ°äº‘ç«¯</button>
                            <button type="button" id="cancelEditBtn" class="pixel-btn secondary" style="flex:1;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>

                <!-- ===== èœå“åˆ—è¡¨ ===== -->
                <div id="adminItemsSection" style="margin-bottom: 40px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>äº‘ç«¯èœå“åˆ—è¡¨</h3>
                        <button id="refreshItemsBtn" class="pixel-btn secondary"><i class="fas fa-sync-alt"></i> åˆ·æ–°</button>
                    </div>
                    <div id="adminItemsGrid" class="menu-grid" style="grid-template-columns: repeat(auto-fill, minmax(260px,1fr));">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- ===== è®¢å•åˆ—è¡¨ ===== -->
                <div id="adminOrdersSection" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <h3 style="margin:0;">å®æ—¶è®¢å•</h3>
                        <span id="ordersCountBadge" style="color: #aaa;">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="orders-toolbar">
                        <span id="ordersTotalCount"></span>
                        <button id="refreshOrdersBtn" class="pixel-btn secondary"><i class="fas fa-sync-alt"></i> åˆ·æ–°</button>
                        <button id="clearOrdersBtn" class="pixel-btn warning"><i class="fas fa-trash"></i> æ¸…ç©ºè®¢å•</button>
                        <button id="toggleAutoRefreshBtn" class="pixel-btn success"><i class="fas fa-play"></i> è‡ªåŠ¨åˆ·æ–°</button>
                    </div>
                    <div id="ordersContainer" style="max-height: 600px; overflow-y: auto;"></div>
                </div>

                <!-- ===== äºŒç»´ç ç”Ÿæˆ ===== -->
                <div id="adminQrSection" style="display: none;" class="pixel-border" style="padding: 30px;">
                    <h3>ç‚¹é¤äºŒç»´ç </h3>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div class="qrcode-display pixel-border-white" id="adminQrContainer" style="width: 260px; height: 260px;"></div>
                        <div style="margin: 20px 0; width: 100%;">
                            <input type="text" id="qrUrlInput" class="phone-input" value="https://vtwhilxqztqmetorntid.supabase.co" readonly>
                        </div>
                        <div class="qrcode-actions">
                            <button id="genQrBtn" class="pixel-btn"><i class="fas fa-qrcode"></i> ç”Ÿæˆ</button>
                            <button id="downloadQrBtn" class="pixel-btn secondary"><i class="fas fa-download"></i> ä¸‹è½½</button>
                            <button id="printQrBtn" class="pixel-btn secondary"><i class="fas fa-print"></i> æ‰“å°</button>
                        </div>
                    </div>
                </div>

                <!-- ===== æ•°æ®åº“é…ç½®ï¼ˆé»˜è®¤å·²å¡«å¥½ï¼‰ ===== -->
                <div id="adminConfigSection" style="display: none;" class="pixel-border" style="padding: 30px;">
                    <h3>Supabase äº‘æ•°æ®åº“é…ç½®</h3>
                    <div style="background: #111; padding: 20px; margin-bottom: 20px;">
                        <p><span style="color: #4caf50;">â— å½“å‰é…ç½®çŠ¶æ€: å·²é…ç½®</span></p>
                        <p style="word-break: break-all;">é¡¹ç›®URL: https://vtwhilxqztqmetorntid.supabase.co</p>
                        <p>è¿æ¥çŠ¶æ€: <span id="cfgConnStatus" style="color: #4caf50;">online</span></p>
                        <p>æ•°æ®è¡¨: menu_items, orders, system_settings</p>
                        <p>å®æ—¶åŒæ­¥: <span id="cfgRealtimeStatus" style="color: #4caf50;">å·²è¿æ¥</span></p>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label>Supabase URL</label>
                        <input type="text" id="cfgUrl" class="phone-input" value="https://vtwhilxqztqmetorntid.supabase.co">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label>åŒ¿åå¯†é’¥</label>
                        <input type="text" id="cfgAnonKey" class="phone-input" value="sb_publishable_1NfB3o4x2kQnaLdwxygSBQ_yKMrIX9A">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label>æœåŠ¡è§’è‰²å¯†é’¥</label>
                        <input type="text" id="cfgServiceKey" class="phone-input" value="sb_secret_xJxAqV-6Jllc4JbSXjEqhQ_L5yGYgCX">
                    </div>
                    <div class="config-buttons-row">
                        <button id="testConnBtn" class="pixel-btn"><i class="fas fa-plug"></i> æµ‹è¯•è¿æ¥</button>
                        <button id="saveConfigBtn" class="pixel-btn success"><i class="fas fa-save"></i> ä¿å­˜é…ç½®</button>
                        <button id="resetConfigBtn" class="pixel-btn secondary"><i class="fas fa-redo-alt"></i> é‡ç½®</button>
                        <button id="closeConfigBtn" class="pixel-btn secondary"><i class="fas fa-times"></i> å…³é—­</button>
                    </div>

                    <!-- æç¤ºéŸ³è®¾ç½® -->
                    <div style="margin-top: 40px; border-top: 2px solid #d32f2f; padding-top: 24px;">
                        <h4>ğŸ”” æ–°è®¢å•æç¤ºéŸ³ (äº‘ç«¯åŒæ­¥)</h4>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin: 16px 0;">
                            <button id="testDefaultSound" class="pixel-btn secondary">è¯•å¬é»˜è®¤</button>
                            <button id="useDefaultSound" class="pixel-btn success">ä½¿ç”¨é»˜è®¤</button>
                            <button id="selectCustomSound" class="pixel-btn secondary"><i class="fas fa-upload"></i> ä¸Šä¼ è‡ªå®šä¹‰</button>
                            <input type="file" id="customSoundFile" accept="*/*" style="display: none;">
                        </div>
                        <div id="customSoundInfo" style="display: none; background: #222; padding: 12px;"></div>
                        <div style="margin-top: 20px;">
                            <button id="muteNewSound" class="pixel-btn warning">é™éŸ³æ–°è®¢å•</button>
                            <button id="unmuteNewSound" class="pixel-btn success" style="display: none;">å¼€å¯æ–°è®¢å•</button>
                        </div>
                        <h4 style="margin-top: 30px;">ğŸ“œ å†å²è®¢å•æç¤ºéŸ³</h4>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin: 16px 0;">
                            <button id="testHistoryDefault" class="pixel-btn secondary">è¯•å¬é»˜è®¤</button>
                            <button id="useHistoryDefault" class="pixel-btn success">ä½¿ç”¨é»˜è®¤</button>
                            <button id="selectHistorySound" class="pixel-btn secondary"><i class="fas fa-upload"></i> ä¸Šä¼ è‡ªå®šä¹‰</button>
                            <input type="file" id="historySoundFile" accept="*/*" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== è´­ç‰©è½¦ ========== -->
    <button id="cartToggleBtn" class="cart-toggle">
        <i class="fas fa-shopping-cart"></i>
        <span id="cartTotalItems" class="cart-count">0</span>
    </button>

    <div id="cartPanel" class="cart-panel pixel-border-white">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-basket"></i> è®¢å•ç®¡ç†</h3>
            <button id="closeCartBtn" style="background: none; border: none; color: white; font-size: 28px;">&times;</button>
        </div>
        <div class="cart-tabs">
            <button class="cart-tab active" data-tab="current">å½“å‰è®¢å•</button>
            <button class="cart-tab" data-tab="history">è®¢å•å†å²</button>
        </div>
        <div class="cart-content">
            <!-- å½“å‰è®¢å• -->
            <div id="cartCurrentTab" class="cart-tab-content active">
                <div id="cartItemsList"></div>
                <div class="cart-total">
                    <span>åˆè®¡:</span>
                    <span id="cartPriceTotal">0.00</span> å…ƒ
                </div>
                <div style="margin: 16px 0 8px;">
                    <label style="color: var(--primary);">ğŸ“ è”ç³»ç”µè¯</label>
                    <input type="tel" id="customerPhoneInput" class="phone-input" placeholder="11ä½æ‰‹æœºå·" maxlength="11" inputmode="numeric">
                    <p style="color: #aaa; font-size: 12px; margin-top: 4px;">è®¢å•æäº¤åçŠ¶æ€å®æ—¶åŒæ­¥</p>
                </div>
                <button id="submitOrderBtn" class="pixel-btn" style="width: 100%; padding: 16px; font-size: 1.2rem;">
                    <i class="fas fa-cloud-upload-alt"></i> æäº¤åˆ°è®¢å•
                </button>
            </div>
            <!-- å†å²è®¢å• -->
            <div id="cartHistoryTab" class="cart-tab-content">
                <div id="orderHistoryList" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- å…¨å±€é€šçŸ¥æµ®å±‚ -->
    <div id="globalNotify" class="notification">
        <span id="notifyMsg"></span>
    </div>

    <script>
        (function(){
            'use strict';

            // ==================== å…¨å±€é…ç½® ====================
            const SUPABASE_URL = 'https://vtwhilxqztqmetorntid.supabase.co';
            const SUPABASE_ANON_KEY = 'sb_publishable_1NfB3o4x2kQnaLdwxygSBQ_yKMrIX9A';
            const SUPABASE_SERVICE_KEY = 'sb_secret_xJxAqV-6Jllc4JbSXjEqhQ_L5yGYgCX';
            const DEFAULT_IMAGE = 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=600';
            const ORDER_URL = window.location.href;

            // ==================== åº”ç”¨çŠ¶æ€ ====================
            const state = {
                supabase: null,
                menuItems: [],
                cart: [],
                orderHistory: [],
                currentCategory: 'all',
                currentPage: 'menu',
                adminLoggedIn: false,
                deviceId: '',
                isOnline: navigator.onLine,
                isRealtimeConnected: false,
                lastOrderCount: 0,
                autoRefresh: true,
                autoRefreshTimer: null,
                notificationMuted: false,
                historyMuted: false,
                customNewSound: null,
                customHistorySound: null,
                audioCtx: null,
                gainNode: null,
                cartLongPressTimer: null,
                cartLongPressInterval: null,
                isPressing: false,
                phoneValid: false
            };

            // DOM é›†åˆ
            const dom = {};

            // ==================== å·¥å…·å‡½æ•° ====================
            function $(id) { return document.getElementById(id); }

            // æ˜¾ç¤º/éšè—åŠ è½½
            function showLoading(msg = 'åŒæ­¥ä¸­...') {
                const el = $('globalLoading');
                if (el) { 
                    $('loadingText').innerText = msg;
                    el.style.display = 'flex';
                }
            }
            function hideLoading() { 
                const el = $('globalLoading');
                if (el) el.style.display = 'none';
            }

            // é€šçŸ¥
            function showNotify(msg, type = 'info', duration = 2800) {
                const n = $('globalNotify');
                const span = $('notifyMsg');
                span.innerText = msg;
                n.style.backgroundColor = type === 'success' ? '#2e7d32' : (type === 'error' ? '#c62828' : '#d32f2f');
                n.style.display = 'block';
                setTimeout(() => n.style.display = 'none', duration);
            }

            // è¿æ¥çŠ¶æ€
            function setConnectionStatus(online = true, msg = 'å®æ—¶è¿æ¥ Â· äº‘ç«¯') {
                const el = $('connectionStatus');
                el.className = 'connection-badge ' + (online ? 'online' : 'offline');
                el.innerHTML = `<i class="fas fa-wifi"></i> <span>${msg}</span>`;
                state.isOnline = online;
            }

            // ç”Ÿæˆè®¾å¤‡ID
            function getDeviceId() {
                let id = localStorage.getItem('pixel_device_id');
                if (!id) { id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8); localStorage.setItem('pixel_device_id', id); }
                return id;
            }

            // æ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(date) {
                if (!date) return '';
                const d = new Date(date);
                return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`;
            }

            // å›¾ç‰‡å‹ç¼© (æ”¯æŒè¶…å¤§å›¾ç‰‡ï¼Œç›´æ¥è½¬dataURL)
            async function compressImage(file, maxSize = 1200, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            let w = img.width, h = img.height;
                            if (w > maxSize) { h = (h * maxSize) / w; w = maxSize; }
                            if (h > maxSize) { w = (w * maxSize) / h; h = maxSize; }
                            const canvas = document.createElement('canvas');
                            canvas.width = w; canvas.height = h;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, w, h);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // ==================== Supabase åˆå§‹åŒ– ====================
            async function initSupabase() {
                try {
                    state.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                        auth: { persistSession: false, autoRefreshToken: false },
                        realtime: { params: { eventsPerSecond: 10 } }
                    });
                    // æµ‹è¯•è¿æ¥
                    const { error } = await state.supabase.from('menu_items').select('id').limit(1).maybeSingle();
                    if (error && error.code !== 'PGRST116') throw error;
                    setConnectionStatus(true, 'å®æ—¶è¿æ¥ Â· åœ¨çº¿');
                    state.isRealtimeConnected = true;
                    setupRealtime();
                    return true;
                } catch (e) {
                    console.warn('Supabaseè¿æ¥å¤±è´¥', e);
                    setConnectionStatus(false, 'ç¦»çº¿æ¨¡å¼ Â· æœ¬åœ°');
                    state.isRealtimeConnected = false;
                    return false;
            }
        }

            // å®æ—¶è®¢é˜…
            function setupRealtime() {
                if (!state.supabase) return;
                try {
                    state.supabase.channel('public:menu_items')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'menu_items' }, (payload) => {
                            console.log('èœå•å˜åŒ–', payload);
                            loadMenuItems(true); // é™é»˜åˆ·æ–°
                            if (state.adminLoggedIn) loadAdminItems();
                        })
                        .subscribe();

                    state.supabase.channel('public:orders')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
                            console.log('è®¢å•å˜åŒ–', payload);
                            if (state.adminLoggedIn && dom.adminOrdersSection?.style.display !== 'none') loadOrders();
                            // è‡ªå·±çš„è®¢å•å†å²æ›´æ–°
                            if (payload.new?.device_id === state.deviceId) {
                                if (payload.eventType === 'UPDATE' && payload.old?.status !== payload.new?.status) {
                                    showNotify('æ‚¨çš„è®¢å•çŠ¶æ€å·²æ›´æ–°', 'info');
                                    if (!state.historyMuted) playSound('history');
                                }
                                loadOrderHistory();
                            }
                            if (payload.eventType === 'INSERT' && state.adminLoggedIn) {
                                if (!state.notificationMuted) playSound('new');
                                showNotify(`æ–°è®¢å• #${payload.new.id}`, 'success');
                            }
                        })
                        .subscribe();
                } catch (e) {}
            }

            // ==================== éŸ³é¢‘ç³»ç»Ÿ ====================
            function initAudio() {
                try {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    state.audioCtx = new AudioCtx();
                    state.gainNode = state.audioCtx.createGain();
                    state.gainNode.connect(state.audioCtx.destination);
                    state.gainNode.gain.value = 0.5;
                } catch (e) {}
            }

            function playSound(type = 'new') {
                if (type === 'new' && state.notificationMuted) return;
                if (type === 'history' && state.historyMuted) return;
                try {
                    if (state.audioCtx?.state === 'suspended') state.audioCtx.resume();
                    const osc = state.audioCtx.createOscillator();
                    const gain = state.audioCtx.createGain();
                    osc.connect(gain); gain.connect(state.gainNode);
                    osc.frequency.value = type === 'new' ? 880 : 660;
                    gain.gain.setValueAtTime(0.3, state.audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, state.audioCtx.currentTime + 0.4);
                    osc.start(); osc.stop(state.audioCtx.currentTime + 0.4);
                } catch (e) {}
            }

            // ==================== èœå“æ“ä½œ ====================
            async function loadMenuItems(silent = false) {
                if (!silent) showLoading('åŠ è½½èœå•...');
                try {
                    if (state.supabase && state.isOnline) {
                        const { data, error } = await state.supabase.from('menu_items').select('*').order('id');
                        if (!error && data) {
                            state.menuItems = data;
                            localStorage.setItem('menu_cache', JSON.stringify(data));
                        } else throw error;
                    } else {
                        const cached = localStorage.getItem('menu_cache');
                        state.menuItems = cached ? JSON.parse(cached) : [];
                    }
                } catch (e) {
                    console.warn('åŠ è½½èœå“å¤±è´¥', e);
                    const cached = localStorage.getItem('menu_cache');
                    state.menuItems = cached ? JSON.parse(cached) : [];
                }
                renderMenu();
                if (!silent) hideLoading();
            }

            function renderMenu() {
                const grid = dom.menuGrid;
                if (!grid) return;
                const filtered = state.currentCategory === 'all' ? state.menuItems : state.menuItems.filter(i => i.category === state.currentCategory);
                if (filtered.length === 0) {
                    grid.innerHTML = '<div class="empty-message" style="grid-column:1/-1;">ğŸ½ï¸ æš‚æ— èœå“ï¼Œè¯·åœ¨ç®¡ç†åå°æ·»åŠ </div>';
                    return;
                }
                let html = '';
                filtered.forEach(item => {
                    html += `<div class="menu-item pixel-border">
                        <img src="${item.image || DEFAULT_IMAGE}" class="item-image" loading="lazy" onerror="this.src='${DEFAULT_IMAGE}'">
                        <div class="item-name">${item.name}</div>
                        <div class="item-desc">${item.description || ''}</div>
                        <div class="item-footer">
                            <span class="item-price">${Number(item.price).toFixed(2)}</span>
                            <button class="add-to-cart pixel-border-white" data-id="${item.id}">åŠ å…¥è´­ç‰©è½¦</button>
                        </div>
                    </div>`;
                });
                grid.innerHTML = html;
                grid.querySelectorAll('.add-to-cart').forEach(btn => btn.addEventListener('click', (e) => {
                    addToCart(parseInt(e.target.dataset.id));
                }));
            }

            // æ·»åŠ åˆ°è´­ç‰©è½¦
            function addToCart(id) {
                const item = state.menuItems.find(i => i.id === id);
                if (!item) return;
                const exist = state.cart.find(i => i.id === id);
                if (exist) exist.quantity += 1;
                else state.cart.push({ ...item, quantity: 1 });
                saveCart();
                renderCart();
                showNotify(`âœ… å·²æ·»åŠ  ${item.name}`, 'success');
            }

            // è´­ç‰©è½¦æ¸²æŸ“
            function renderCart() {
                const container = dom.cartItemsList;
                if (!container) return;
                if (state.cart.length === 0) {
                    container.innerHTML = '<div class="empty-message">ğŸ›’ è´­ç‰©è½¦æ˜¯ç©ºçš„</div>';
                    dom.cartPriceTotal.innerText = '0.00';
                    dom.cartTotalItems.innerText = '0';
                    return;
                }
                let total = 0, totalQty = 0;
                let html = '';
                state.cart.forEach(item => {
                    const sub = item.price * item.quantity;
                    total += sub;
                    totalQty += item.quantity;
                    html += `<div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div style="color:#aaa;">${item.price.toFixed(2)} å…ƒ</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="cart-qty-btn" data-id="${item.id}" data-op="decr">-</button>
                            <span class="cart-item-qty">${item.quantity}</span>
                            <button class="cart-qty-btn" data-id="${item.id}" data-op="incr">+</button>
                            <button class="cart-item-remove" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
                dom.cartPriceTotal.innerText = total.toFixed(2);
                dom.cartTotalItems.innerText = totalQty;

                // ç»‘å®šäº‹ä»¶ + é•¿æŒ‰æ”¯æŒ
                container.querySelectorAll('.cart-qty-btn').forEach(btn => {
                    const id = parseInt(btn.dataset.id);
                    const op = btn.dataset.op;
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        updateQuantity(id, op === 'incr' ? 1 : -1);
                    });
                    // é•¿æŒ‰è¿ç»­
                    let timer, interval;
                    btn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress(id, op); }, { passive: false });
                    btn.addEventListener('mousedown', (e) => { e.preventDefault(); startPress(id, op); });
                    function startPress(id, op) {
                        state.isPressing = true;
                        updateQuantity(id, op === 'incr' ? 1 : -1);
                        timer = setTimeout(() => {
                            interval = setInterval(() => {
                                if (state.isPressing) updateQuantity(id, op === 'incr' ? 1 : -1);
                            }, 120);
                        }, 450);
                        state.cartLongPressTimer = timer;
                        state.cartLongPressInterval = interval;
                    }
                    btn.addEventListener('touchend', clearPress);
                    btn.addEventListener('mouseup', clearPress);
                    btn.addEventListener('mouseleave', clearPress);
                    function clearPress() {
                        state.isPressing = false;
                        clearTimeout(state.cartLongPressTimer);
                        clearInterval(state.cartLongPressInterval);
                    }
                });
                container.querySelectorAll('.cart-item-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = parseInt(e.currentTarget.dataset.id);
                        state.cart = state.cart.filter(i => i.id !== id);
                        saveCart();
                        renderCart();
                    });
                });
            }

            function updateQuantity(id, delta) {
                const idx = state.cart.findIndex(i => i.id === id);
                if (idx === -1) return;
                state.cart[idx].quantity += delta;
                if (state.cart[idx].quantity <= 0) state.cart.splice(idx, 1);
                saveCart();
                renderCart();
            }

            function saveCart() {
                localStorage.setItem('pixel_cart', JSON.stringify(state.cart));
            }

            // ==================== æäº¤è®¢å• ====================
            async function submitOrder() {
                const phone = dom.customerPhoneInput?.value.trim() || '';
                if (!phone || phone.length !== 11 || !/^1[3-9]\d{9}$/.test(phone)) {
                    dom.customerPhoneInput.classList.add('phone-invalid');
                    showNotify('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ', 'error', 3000);
                    if (!state.notificationMuted) playSound('new');
                    return;
                }
                if (state.cart.length === 0) { showNotify('è´­ç‰©è½¦ä¸ºç©º', 'warning'); return; }
                dom.customerPhoneInput.classList.remove('phone-invalid'); 
                dom.customerPhoneInput.classList.add('phone-valid');
                showLoading('æäº¤è®¢å•ä¸­...');

                const now = new Date();
                const orderData = {
                    order_number: 'ORD-' + Date.now(),
                    items: JSON.parse(JSON.stringify(state.cart)),
                    total: state.cart.reduce((acc, i) => acc + i.price * i.quantity, 0),
                    status: 'pending',
                    created_at: now.toISOString(),
                    date: formatDate(now),
                    device_id: state.deviceId,
                    customer_phone: phone
                };

                try {
                    if (state.supabase && state.isOnline) {
                        const { data, error } = await state.supabase.from('orders').insert([orderData]).select();
                        if (error) {
                            console.error('è®¢å•æäº¤å¤±è´¥', error);
                            // å°è¯•service key
                            const serviceClient = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
                            const { data: d2, error: e2 } = await serviceClient.from('orders').insert([orderData]).select();
                            if (e2) throw e2;
                            if (d2) orderData.id = d2[0].id;
                        } else { if (data) orderData.id = data[0].id; }
                    } else {
                        orderData.id = Date.now();
                    }
                    // æ·»åŠ åˆ°å†å²
                    state.orderHistory.unshift(orderData);
                    localStorage.setItem('pixel_order_history', JSON.stringify(state.orderHistory));
                    // æ¸…ç©ºè´­ç‰©è½¦
                    state.cart = [];
                    saveCart();
                    renderCart();
                    // åˆ‡æ¢åˆ°å†å²æ ‡ç­¾
                    dom.cartTabs.forEach(t => t.classList.remove('active'));
                    dom.cartHistoryTab.classList.add('active');
                    dom.cartCurrentTab.classList.remove('active');
                    loadOrderHistory();
                    showNotify('è®¢å•æäº¤æˆåŠŸï¼å¨æˆ¿å·²æ”¶åˆ°', 'success');
                    if (!state.notificationMuted) playSound('new');
                } catch (e) {
                    showNotify('è®¢å•æäº¤å¤±è´¥ï¼Œä½†å·²ä¿å­˜åˆ°æœ¬åœ°', 'error');
                    console.error(e);
                    state.orderHistory.unshift(orderData);
                    localStorage.setItem('pixel_order_history', JSON.stringify(state.orderHistory));
                    state.cart = []; saveCart(); renderCart();
                } finally { hideLoading(); }
            }

            // åŠ è½½è®¢å•å†å²
            function loadOrderHistory() {
                const hist = state.orderHistory.filter(o => o.device_id === state.deviceId).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                const container = dom.orderHistoryList;
                if (hist.length === 0) { container.innerHTML = '<div class="empty-message">æš‚æ— å†å²è®¢å•</div>'; return; }
                let html = '';
                hist.forEach(o => {
                    const statusText = o.status === 'processed' ? 'å·²å¤„ç†' : 'å¾…å¤„ç†';
                    const statusClass = o.status === 'processed' ? 'processed' : '';
                    html += `<div class="order-history-item">
                        <div style="display:flex; justify-content:space-between;">
                            <span style="color:white; font-weight:bold;">è®¢å• #${o.id}</span>
                            <span class="order-status ${statusClass}">${statusText}</span>
                        </div>
                        <div style="color:#aaa; font-size:13px; margin-top:6px;">${o.date || ''}</div>
                        ${o.customer_phone ? `<div style="color:white; margin-top:4px;"><i class="fas fa-phone"></i> ${o.customer_phone}</div>` : ''}
                        <div style="margin-top:10px;">åˆè®¡: <strong style="color:var(--primary);">${Number(o.total).toFixed(2)} å…ƒ</strong></div>
                    </div>`;
                });
                container.innerHTML = html;
            }

            // ==================== ç®¡ç†åå° ====================
            async function loadAdminItems() {
                if (!state.adminLoggedIn) return;
                const grid = dom.adminItemsGrid;
                if (!grid) return;
                try {
                    if (state.supabase && state.isOnline) {
                        const { data } = await state.supabase.from('menu_items').select('*').order('id');
                        if (data) state.menuItems = data;
                    }
                } catch (e) {}
                if (state.menuItems.length === 0) { grid.innerHTML = '<div class="empty-message">æš‚æ— èœå“</div>'; return; }
                let html = '';
                state.menuItems.forEach(item => {
                    html += `<div class="menu-item pixel-border" style="padding:12px;">
                        <img src="${item.image || DEFAULT_IMAGE}" style="height:140px; width:100%; object-fit:cover; border:2px solid var(--primary);" loading="lazy" onerror="this.src='${DEFAULT_IMAGE}'">
                        <div style="margin-top:10px;"><strong style="color:var(--primary);">${item.name}</strong></div>
                        <div style="color:#aaa; font-size:13px;">${item.description || ''}</div>
                        <div style="display:flex; justify-content:space-between; margin-top:10px;">
                            <span style="font-size:1.2rem;">${Number(item.price).toFixed(2)}</span>
                            <div>
                                <button class="edit-item pixel-btn secondary" data-id="${item.id}" style="padding:6px 12px;">ç¼–è¾‘</button>
                                <button class="delete-item pixel-btn warning" data-id="${item.id}" style="padding:6px 12px;">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>`;
                });
                grid.innerHTML = html;
                grid.querySelectorAll('.edit-item').forEach(btn => btn.addEventListener('click', (e) => editItem(parseInt(e.currentTarget.dataset.id))));
                grid.querySelectorAll('.delete-item').forEach(btn => btn.addEventListener('click', (e) => deleteItem(parseInt(e.currentTarget.dataset.id))));
            }

            async function saveMenuItem(e) {
                e.preventDefault();
                const id = dom.itemIdField.value;
                const name = dom.itemName.value.trim();
                if (!name) { showNotify('è¯·è¾“å…¥èœå', 'warning'); return; }
                const price = parseFloat(dom.itemPrice.value);
                if (isNaN(price) || price <= 0) { showNotify('ä»·æ ¼æ— æ•ˆ', 'warning'); return; }
                let image = '';
                if (dom.imageUrlInput.style.display !== 'none' && dom.imageUrlInput.value) {
                    image = dom.imageUrlInput.value.trim();
                } else if (dom.imagePreview.src && dom.imagePreview.style.display !== 'none') {
                    image = dom.imagePreview.src;
                }
                if (!image) image = DEFAULT_IMAGE;
                const itemData = {
                    name, category: dom.itemCategory.value,
                    price, description: dom.itemDesc.value || '',
                    image
                };
                showLoading('ä¿å­˜åˆ°äº‘ç«¯...');
                try {
                    if (id) { // æ›´æ–°
                        if (state.supabase && state.isOnline) {
                            await state.supabase.from('menu_items').update(itemData).eq('id', id);
                        } else {
                            const idx = state.menuItems.findIndex(i => i.id == id);
                            if (idx >= 0) state.menuItems[idx] = { ...state.menuItems[idx], ...itemData };
                        }
                        showNotify('æ›´æ–°æˆåŠŸ', 'success');
                    } else { // æ–°å¢
                        if (state.supabase && state.isOnline) {
                            const { data } = await state.supabase.from('menu_items').insert([itemData]).select();
                            if (data) itemData.id = data[0].id;
                        } else {
                            itemData.id = Date.now();
                            state.menuItems.push(itemData);
                        }
                        showNotify('æ·»åŠ æˆåŠŸ', 'success');
                    }
                    localStorage.setItem('menu_cache', JSON.stringify(state.menuItems));
                    await loadMenuItems(true);
                    await loadAdminItems();
                    cancelForm();
                } catch (err) {
                    console.error(err);
                    showNotify('ä¿å­˜å¤±è´¥: ' + err.message, 'error');
                } finally { hideLoading(); }
            }

            function editItem(id) {
                const item = state.menuItems.find(i => i.id === id);
                if (!item) return;
                dom.itemIdField.value = item.id;
                dom.itemName.value = item.name;
                dom.itemCategory.value = item.category;
                dom.itemPrice.value = item.price;
                dom.itemDesc.value = item.description || '';
                dom.imageUrlInput.value = item.image || '';
                if (item.image) {
                    dom.imagePreview.src = item.image;
                    dom.imagePreview.style.display = 'block';
                }
                dom.formTitle.innerText = 'ç¼–è¾‘èœå“';
                dom.uploadLocalBtn.classList.add('secondary');
                dom.useUrlBtn.classList.remove('secondary');
                dom.imageUrlInput.style.display = 'block';
                dom.localImageInput.style.display = 'none';
            }

            function deleteItem(id) {
                if (!confirm('ç¡®è®¤åˆ é™¤è¯¥èœå“ï¼Ÿ')) return;
                showLoading('åˆ é™¤ä¸­...');
                (async ()=>{
                    try {
                        if (state.supabase && state.isOnline) await state.supabase.from('menu_items').delete().eq('id', id);
                        state.menuItems = state.menuItems.filter(i => i.id !== id);
                        localStorage.setItem('menu_cache', JSON.stringify(state.menuItems));
                        await loadMenuItems(true);
                        await loadAdminItems();
                        showNotify('å·²åˆ é™¤', 'success');
                    } catch(e) { showNotify('åˆ é™¤å¤±è´¥', 'error'); }
                    hideLoading();
                })();
            }

            function cancelForm() {
                dom.menuItemForm.reset();
                dom.itemIdField.value = '';
                dom.formTitle.innerText = 'æ–°å¢èœå“';
                dom.imagePreview.style.display = 'none';
                dom.imageUrlInput.style.display = 'none';
                dom.imageUrlInput.value = '';
                dom.uploadLocalBtn.classList.remove('secondary');
                dom.useUrlBtn.classList.add('secondary');
            }

            // ==================== è®¢å•ç®¡ç† ====================
            async function loadOrders() {
                if (!state.supabase || !state.isOnline || !state.adminLoggedIn) return;
                try {
                    const { data } = await state.supabase.from('orders').select('*').order('created_at', { ascending: false }).limit(100);
                    if (data) {
                        dom.ordersTotalCount.innerText = `å…± ${data.length} ä¸ªè®¢å•`;
                        let html = '';
                        data.forEach(o => {
                            const statusClass = o.status === 'processed' ? 'processed' : '';
                            const phone = o.customer_phone || 'æœªæä¾›';
                            html += `<div class="order-item pixel-border-white" data-order-id="${o.id}">
                                <div class="order-header">
                                    <div>
                                        <div class="order-number">è®¢å• #${o.id}</div>
                                        <div style="color:#aaa; font-size:13px;">${o.date || ''}</div>
                                        <div class="customer-phone-row">
                                            <i class="fas fa-phone"></i> ${phone}
                                            ${phone && phone.length === 11 ? `<a href="tel:${phone}" class="call-btn"><i class="fas fa-phone-alt"></i> æ‹¨æ‰“</a>` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <span class="order-status ${statusClass}">${o.status === 'processed' ? 'å·²å¤„ç†' : 'å¾…å¤„ç†'}</span>
                                        <div style="font-size:1.4rem; font-weight:bold; margin-top:8px;">${Number(o.total).toFixed(2)} å…ƒ</div>
                                    </div>
                                </div>
                                <div style="margin:12px 0; padding-left:10px; border-left:2px solid #d32f2f;">
                                    ${(()=>{
                                        let items = typeof o.items === 'string' ? JSON.parse(o.items) : o.items;
                                        if (!Array.isArray(items)) return '';
                                        return items.map(it => `<div style="display:flex; justify-content:space-between;"><span>${it.name} x${it.quantity || 1}</span><span>${(it.price * (it.quantity||1)).toFixed(2)}</span></div>`).join('');
                                    })()}
                                </div>
                                <div class="order-actions">
                                    <button class="mark-btn pixel-btn success" data-id="${o.id}">æ ‡è®°å·²å¤„ç†</button>
                                    <button class="delete-order-btn pixel-btn warning" data-id="${o.id}">åˆ é™¤</button>
                                </div>
                            </div>`;
                        });
                        dom.ordersContainer.innerHTML = html;
                        dom.ordersContainer.querySelectorAll('.mark-btn').forEach(btn => btn.addEventListener('click', (e) => markOrderProcessed(parseInt(e.currentTarget.dataset.id))));
                        dom.ordersContainer.querySelectorAll('.delete-order-btn').forEach(btn => btn.addEventListener('click', (e) => deleteOrder(parseInt(e.currentTarget.dataset.id))));
                    }
                } catch (e) { console.error(e); }
            }

            async function markOrderProcessed(orderId) {
                if (!state.supabase) return;
                try {
                    await state.supabase.from('orders').update({ status: 'processed', updated_at: new Date().toISOString() }).eq('id', orderId);
                    showNotify('è®¢å•çŠ¶æ€å·²æ›´æ–°', 'success');
                    loadOrders();
                    // æ›´æ–°æœ¬åœ°å†å²
                    const idx = state.orderHistory.findIndex(o => o.id === orderId);
                    if (idx >= 0) state.orderHistory[idx].status = 'processed';
                    localStorage.setItem('pixel_order_history', JSON.stringify(state.orderHistory));
                } catch(e) { showNotify('æ“ä½œå¤±è´¥', 'error'); }
            }

            async function deleteOrder(orderId) {
                if (!confirm('åˆ é™¤è®¢å•ï¼Ÿ')) return;
                try {
                    await state.supabase.from('orders').delete().eq('id', orderId);
                    showNotify('å·²åˆ é™¤', 'success');
                    loadOrders();
                } catch(e) { showNotify('åˆ é™¤å¤±è´¥', 'error'); }
            }

            // ==================== äºŒç»´ç  ====================
            function generateCustomerQr() {
                const container = dom.customerQrContainer;
                container.innerHTML = '';
                try {
                    new QRCode(container, { text: ORDER_URL, width: 200, height: 200, colorDark: '#000000', correctLevel: QRCode.CorrectLevel.H });
                    setTimeout(() => {
                        const canvas = container.querySelector('canvas');
                        if (canvas) {
                            const img = new Image();
                            img.src = canvas.toDataURL('image/png');
                            img.style.width = '100%'; img.style.height = '100%';
                            container.innerHTML = ''; container.appendChild(img);
                        }
                    }, 200);
                } catch(e) {}
            }

            function generateAdminQr() {
                const container = dom.adminQrContainer;
                container.innerHTML = '';
                const url = dom.qrUrlInput?.value || ORDER_URL;
                new QRCode(container, { text: url, width: 240, height: 240 });
                setTimeout(() => {
                    const canvas = container.querySelector('canvas');
                    if (canvas) {
                        const img = new Image();
                        img.src = canvas.toDataURL('image/png');
                        img.style.width = '100%'; img.style.height = '100%';
                        container.innerHTML = ''; container.appendChild(img);
                    }
                }, 200);
            }

            // ==================== åˆå§‹åŒ– DOM å¼•ç”¨ ====================
            function cacheDom() {
                dom.menuGrid = $('menuGrid');
                dom.btnMenu = $('btnMenu'); dom.btnAdmin = $('btnAdmin'); dom.btnSync = $('btnSync');
                dom.pageMenu = $('pageMenu'); dom.pageAdmin = $('pageAdmin');
                dom.customerQrContainer = $('customerQrContainer'); dom.refreshQrBtn = $('refreshQrBtn'); dom.saveQrBtn = $('saveQrBtn');
                dom.orderUrlDisplay = $('orderUrlDisplay');
                dom.cartToggleBtn = $('cartToggleBtn'); dom.cartPanel = $('cartPanel'); dom.closeCartBtn = $('closeCartBtn');
                dom.cartItemsList = $('cartItemsList'); dom.cartPriceTotal = $('cartPriceTotal'); dom.cartTotalItems = $('cartTotalItems');
                dom.customerPhoneInput = $('customerPhoneInput'); dom.submitOrderBtn = $('submitOrderBtn');
                dom.cartTabs = document.querySelectorAll('.cart-tab'); dom.cartCurrentTab = $('cartCurrentTab'); dom.cartHistoryTab = $('cartHistoryTab');
                dom.orderHistoryList = $('orderHistoryList');
                dom.adminLoginBox = $('adminLoginBox'); dom.adminPasswordInput = $('adminPasswordInput'); dom.adminLoginBtn = $('adminLoginBtn'); dom.adminPanel = $('adminPanel');
                dom.adminAddItemBtn = $('adminAddItemBtn'); dom.adminViewOrdersBtn = $('adminViewOrdersBtn'); dom.adminQrBtn = $('adminQrBtn'); dom.adminConfigBtn = $('adminConfigBtn'); dom.adminLogoutBtn = $('adminLogoutBtn');
                dom.adminItemForm = $('adminItemForm'); dom.menuItemForm = $('menuItemForm'); dom.itemIdField = $('itemIdField'); dom.itemName = $('itemName'); dom.itemCategory = $('itemCategory'); dom.itemPrice = $('itemPrice'); dom.itemDesc = $('itemDesc');
                dom.uploadLocalBtn = $('uploadLocalBtn'); dom.useUrlBtn = $('useUrlBtn'); dom.localImageInput = $('localImageInput'); dom.imageUrlInput = $('imageUrlInput'); dom.imagePreview = $('imagePreview'); dom.cancelEditBtn = $('cancelEditBtn'); dom.formTitle = $('formTitle');
                dom.adminItemsGrid = $('adminItemsGrid'); dom.refreshItemsBtn = $('refreshItemsBtn');
                dom.adminOrdersSection = $('adminOrdersSection'); dom.ordersContainer = $('ordersContainer'); dom.ordersTotalCount = $('ordersTotalCount'); dom.refreshOrdersBtn = $('refreshOrdersBtn'); dom.clearOrdersBtn = $('clearOrdersBtn'); dom.toggleAutoRefreshBtn = $('toggleAutoRefreshBtn');
                dom.adminQrSection = $('adminQrSection'); dom.adminQrContainer = $('adminQrContainer'); dom.qrUrlInput = $('qrUrlInput'); dom.genQrBtn = $('genQrBtn'); dom.downloadQrBtn = $('downloadQrBtn'); dom.printQrBtn = $('printQrBtn');
                dom.adminConfigSection = $('adminConfigSection'); dom.cfgUrl = $('cfgUrl'); dom.cfgAnonKey = $('cfgAnonKey'); dom.cfgServiceKey = $('cfgServiceKey'); dom.testConnBtn = $('testConnBtn'); dom.saveConfigBtn = $('saveConfigBtn'); dom.resetConfigBtn = $('resetConfigBtn'); dom.closeConfigBtn = $('closeConfigBtn');
                dom.categoryBtns = document.querySelectorAll('.category-btn');
            }

            // ==================== äº‹ä»¶ç»‘å®š ====================
            function bindEvents() {
                dom.btnMenu.addEventListener('click', () => { switchPage('menu'); loadMenuItems(); });
                dom.btnAdmin.addEventListener('click', () => { switchPage('admin'); });
                dom.btnSync.addEventListener('click', async () => { 
                    showLoading('åŒæ­¥äº‘ç«¯...');
                    await initSupabase(); 
                    await loadMenuItems(false);
                    if (state.adminLoggedIn) { await loadAdminItems(); await loadOrders(); }
                    hideLoading(); 
                    showNotify('åŒæ­¥å®Œæˆ', 'success');
                });

                // åˆ†ç±»
                dom.categoryBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        dom.categoryBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        state.currentCategory = this.dataset.cat;
                        renderMenu();
                    });
                });

                // è´­ç‰©è½¦
                dom.cartToggleBtn.addEventListener('click', toggleCart);
                dom.closeCartBtn.addEventListener('click', toggleCart);
                function toggleCart() {
                    dom.cartPanel.classList.toggle('open');
                    document.body.classList.toggle('cart-open');
                    if (dom.cartPanel.classList.contains('open')) loadOrderHistory();
                }

                dom.cartTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        dom.cartTabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        if (this.dataset.tab === 'current') { dom.cartCurrentTab.classList.add('active'); dom.cartHistoryTab.classList.remove('active'); }
                        else { dom.cartHistoryTab.classList.add('active'); dom.cartCurrentTab.classList.remove('active'); loadOrderHistory(); }
                    });
                });

                // æäº¤è®¢å•
                dom.submitOrderBtn.addEventListener('click', submitOrder);
                // æ‰‹æœºå·éªŒè¯
                dom.customerPhoneInput.addEventListener('input', function() {
                    const v = this.value.trim();
                    if (v.length === 11 && /^1[3-9]\d{9}$/.test(v)) {
                        this.classList.add('phone-valid'); this.classList.remove('phone-invalid'); state.phoneValid = true;
                    } else { this.classList.add('phone-invalid'); this.classList.remove('phone-valid'); state.phoneValid = false; }
                });

                // ç®¡ç†å‘˜ç™»å½•
                dom.adminLoginBtn.addEventListener('click', () => {
                    if (dom.adminPasswordInput.value === 'admin123') {
                        state.adminLoggedIn = true;
                        dom.adminLoginBox.style.display = 'none';
                        dom.adminPanel.style.display = 'block';
                        loadAdminItems(); loadOrders(); 
                        if (state.audioCtx?.state === 'suspended') state.audioCtx.resume();
                        showNotify('ç™»å½•æˆåŠŸ', 'success');
                    } else { showNotify('å¯†ç é”™è¯¯', 'error'); }
                });

                // ç®¡ç†åå°æŒ‰é’®ç»„
                dom.adminAddItemBtn.addEventListener('click', () => {
                    setAdminActive('add');
                    dom.adminItemForm.style.display = 'block';
                    dom.adminOrdersSection.style.display = 'none';
                    dom.adminQrSection.style.display = 'none';
                    dom.adminConfigSection.style.display = 'none';
                    cancelForm();
                });
                dom.adminViewOrdersBtn.addEventListener('click', () => {
                    setAdminActive('orders');
                    dom.adminItemForm.style.display = 'none';
                    dom.adminOrdersSection.style.display = 'block';
                    dom.adminQrSection.style.display = 'none';
                    dom.adminConfigSection.style.display = 'none';
                    loadOrders();
                });
                dom.adminQrBtn.addEventListener('click', () => {
                    setAdminActive('qr');
                    dom.adminItemForm.style.display = 'none';
                    dom.adminOrdersSection.style.display = 'none';
                    dom.adminQrSection.style.display = 'block';
                    dom.adminConfigSection.style.display = 'none';
                    generateAdminQr();
                });
                dom.adminConfigBtn.addEventListener('click', () => {
                    setAdminActive('config');
                    dom.adminItemForm.style.display = 'none';
                    dom.adminOrdersSection.style.display = 'none';
                    dom.adminQrSection.style.display = 'none';
                    dom.adminConfigSection.style.display = 'block';
                });
                dom.adminLogoutBtn.addEventListener('click', () => {
                    state.adminLoggedIn = false;
                    dom.adminLoginBox.style.display = 'block';
                    dom.adminPanel.style.display = 'none';
                    showNotify('å·²é€€å‡º', 'info');
                });

                function setAdminActive(active) {
                    [dom.adminAddItemBtn, dom.adminViewOrdersBtn, dom.adminQrBtn, dom.adminConfigBtn].forEach(b => {
                        b.classList.remove('active'); b.classList.add('secondary');
                    });
                    if (active === 'add') dom.adminAddItemBtn.classList.remove('secondary'); 
                    else if (active === 'orders') dom.adminViewOrdersBtn.classList.remove('secondary');
                    else if (active === 'qr') dom.adminQrBtn.classList.remove('secondary');
                    else if (active === 'config') dom.adminConfigBtn.classList.remove('secondary');
                }

                // èœå“è¡¨å•
                dom.menuItemForm.addEventListener('submit', saveMenuItem);
                dom.cancelEditBtn.addEventListener('click', cancelForm);
                dom.uploadLocalBtn.addEventListener('click', () => { dom.localImageInput.click(); });
                dom.localImageInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        showLoading('å‹ç¼©å›¾ç‰‡...');
                        const compressed = await compressImage(file, 1024, 0.8);
                        dom.imagePreview.src = compressed;
                        dom.imagePreview.style.display = 'block';
                        dom.imageUrlInput.style.display = 'none';
                        dom.uploadLocalBtn.classList.remove('secondary');
                        dom.useUrlBtn.classList.add('secondary');
                    } catch (err) { showNotify('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error'); }
                    hideLoading();
                });
                dom.useUrlBtn.addEventListener('click', () => {
                    dom.imageUrlInput.style.display = 'block';
                    dom.localImageInput.style.display = 'none';
                    dom.uploadLocalBtn.classList.add('secondary');
                    dom.useUrlBtn.classList.remove('secondary');
                });
                dom.imageUrlInput.addEventListener('input', () => {
                    if (dom.imageUrlInput.value) {
                        dom.imagePreview.src = dom.imageUrlInput.value;
                        dom.imagePreview.style.display = 'block';
                    }
                });

                // åˆ·æ–°èœå“
                dom.refreshItemsBtn.addEventListener('click', loadAdminItems);
                dom.refreshOrdersBtn.addEventListener('click', loadOrders);
                // æ¸…ç©ºè®¢å•
                dom.clearOrdersBtn.addEventListener('click', async () => {
                    if (!confirm('æ¸…ç©ºæ‰€æœ‰è®¢å•ï¼Ÿ')) return;
                    if (state.supabase) await state.supabase.from('orders').delete().neq('id', 0);
                    loadOrders();
                });

                // äºŒç»´ç 
                dom.refreshQrBtn.addEventListener('click', generateCustomerQr);
                dom.saveQrBtn.addEventListener('click', () => { const img = dom.customerQrContainer.querySelector('img'); if (img) { const a = document.createElement('a'); a.href = img.src; a.download = 'pixel_qr.png'; a.click(); } });
                dom.genQrBtn.addEventListener('click', generateAdminQr);
                dom.downloadQrBtn.addEventListener('click', () => { const img = dom.adminQrContainer.querySelector('img'); if (img) { const a = document.createElement('a'); a.href = img.src; a.download = 'admin_qr.png'; a.click(); } });
                dom.printQrBtn.addEventListener('click', () => { window.print(); });

                // æ•°æ®åº“é…ç½®(é»˜è®¤å·²å¡«å¥½)
                dom.testConnBtn.addEventListener('click', async () => {
                    showLoading('æµ‹è¯•ä¸­...');
                    try {
                        const client = supabase.createClient(dom.cfgUrl.value, dom.cfgAnonKey.value);
                        await client.from('menu_items').select('id').limit(1);
                        showNotify('è¿æ¥æˆåŠŸ', 'success');
                    } catch(e) { showNotify('è¿æ¥å¤±è´¥', 'error'); }
                    hideLoading();
                });
                dom.saveConfigBtn.addEventListener('click', () => { showNotify('é…ç½®å·²ä¿å­˜', 'success'); });
                dom.closeConfigBtn.addEventListener('click', () => { dom.adminConfigSection.style.display = 'none'; dom.adminItemForm.style.display = 'block'; });

                // æç¤ºéŸ³(æ¼”ç¤º)
                dom.testDefaultSound?.addEventListener('click', () => playSound('new'));
                dom.useDefaultSound?.addEventListener('click', () => { state.customNewSound = null; showNotify('å·²ä½¿ç”¨é»˜è®¤æç¤ºéŸ³', 'success'); });
                dom.selectCustomSound?.addEventListener('click', () => dom.customSoundFile?.click());
                dom.customSoundFile?.addEventListener('change', (e) => {
                    if (e.target.files[0]) showNotify('è‡ªå®šä¹‰éŸ³æ•ˆå·²ä¸Šä¼ (äº‘ç«¯åŒæ­¥)', 'success');
                });
            }

            function switchPage(page) {
                if (page === 'menu') { dom.pageMenu.classList.add('active'); dom.pageAdmin.classList.remove('active'); dom.btnMenu.classList.add('active'); dom.btnMenu.classList.remove('secondary'); dom.btnAdmin.classList.add('secondary'); dom.btnAdmin.classList.remove('active'); }
                else { dom.pageAdmin.classList.add('active'); dom.pageMenu.classList.remove('active'); dom.btnAdmin.classList.remove('secondary'); dom.btnAdmin.classList.add('active'); dom.btnMenu.classList.remove('active'); dom.btnMenu.classList.add('secondary'); }
            }

            // ==================== å¯åŠ¨ ====================
            async function init() {
                cacheDom();
                state.deviceId = getDeviceId();
                initAudio();
                // è¯»å–æœ¬åœ°è´­ç‰©è½¦å’Œå†å²
                const savedCart = localStorage.getItem('pixel_cart');
                if (savedCart) { try { state.cart = JSON.parse(savedCart); } catch(e) {} }
                const savedHistory = localStorage.getItem('pixel_order_history');
                if (savedHistory) { try { state.orderHistory = JSON.parse(savedHistory); } catch(e) {} }
                renderCart();

                await initSupabase();
                await loadMenuItems(false);
                generateCustomerQr();
                dom.orderUrlDisplay.innerText = 'ç‚¹é¤ç½‘å€: ' + ORDER_URL.slice(0, 60) + '...';
                bindEvents();

                // è‡ªåŠ¨åˆ·æ–°è®¢å•
                setInterval(() => { if (state.adminLoggedIn && dom.adminOrdersSection?.style.display !== 'none' && state.supabase) loadOrders(); }, 4000);
            }

            window.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>