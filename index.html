<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>像素食堂 · 云点餐 | 实时同步</title>
    <!-- Font Awesome & 二维码库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        /* 像素复古风格 (保持原样，只微调关键点) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', 'DotGothic16', monospace; -webkit-tap-highlight-color: transparent; }
        :root { --primary-color: #d32f2f; --secondary-color: #ffffff; --bg-color: #0f0f0f; --pixel-border: 4px; --grid-color: rgba(255,255,255,0.05); --scanline-color: rgba(0,255,0,0.1); --success-color: #4caf50; --warning-color: #ff9800; --error-color: #f44336; }
        body { background-color: var(--bg-color); color: var(--secondary-color); background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px); background-size: 20px 20px; min-height: 100vh; overflow-x: hidden; position: relative; touch-action: manipulation; -webkit-overflow-scrolling: touch; }
        html { touch-action: manipulation; }
        body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, transparent 50%, var(--scanline-color) 51%); background-size: 100% 4px; pointer-events: none; z-index: 999; animation: scanline 10s linear infinite; opacity: 0.3; }
        @keyframes scanline { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        .pixel-border { border-style: solid; border-width: var(--pixel-border); border-image-slice: 2; border-image-width: 2; border-image-outset: 0; border-image-source: url('data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8" ?><svg width="8" height="8" xmlns="http://www.w3.org/2000/svg"><path d="M3 1 h1 v1 h-1 z M4 1 h1 v1 h-1 z M2 2 h1 v1 h-1 z M5 2 h1 v1 h-1 z M1 3 h1 v1 h-1 z M6 3 h1 v1 h-1 z M1 4 h1 v1 h-1 z M6 4 h1 v1 h-1 z M2 5 h1 v1 h-1 z M5 5 h1 v1 h-1 z M3 6 h1 v1 h-1 z M4 6 h1 v1 h-1 z" fill="rgb(211, 47, 47)" /></svg>'); background-color: var(--bg-color); }
        .pixel-border-white { border-image-source: url('data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8" ?><svg width="8" height="8" xmlns="http://www.w3.org/2000/svg"><path d="M3 1 h1 v1 h-1 z M4 1 h1 v1 h-1 z M2 2 h1 v1 h-1 z M5 2 h1 v1 h-1 z M1 3 h1 v1 h-1 z M6 3 h1 v1 h-1 z M1 4 h1 v1 h-1 z M6 4 h1 v1 h-1 z M2 5 h1 v1 h-1 z M5 5 h1 v1 h-1 z M3 6 h1 v1 h-1 z M4 6 h1 v1 h-1 z" fill="rgb(255, 255, 255)" /></svg>'); }
        .pixel-button { display: inline-block; padding: 12px 24px; background-color: var(--primary-color); color: var(--secondary-color); border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; position: relative; text-align: center; transition: all 0.1s; font-size: 16px; margin: 5px; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        .pixel-button:active { transform: translate(2px, 2px); }
        .pixel-button::before, .pixel-button::after { content: ''; position: absolute; width: 100%; height: 100%; box-sizing: content-box; }
        .pixel-button::before { top: -4px; left: 0; border-top: 4px solid white; border-bottom: 4px solid white; }
        .pixel-button::after { left: -4px; top: 0; border-left: 4px solid white; border-right: 4px solid white; }
        .pixel-button.active::before, .pixel-button.active::after { border-color: #d32f2f !important; }
        .pixel-button.secondary { background-color: #333; }
        .pixel-button.success { background-color: var(--success-color); }
        .pixel-button.warning { background-color: var(--warning-color); }
        h1, h2, h3 { color: var(--primary-color); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; text-shadow: 2px 2px 0 #000; }
        h1 { font-size: 36px; position: relative; display: inline-block; width: 100%; text-align: center; }
        h1::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 4px; background-color: var(--primary-color); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; overflow-x: hidden; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 30px; flex-wrap: wrap; }
        .header-controls { display: flex; flex-wrap: nowrap; align-items: center; gap: 10px; min-width: 0; width: 100%; justify-content: center; margin-top: 20px; order: 2; }
        .header-controls .pixel-button { white-space: nowrap; flex-shrink: 0; min-width: 100px; text-align: center; font-size: clamp(14px, 3vw, 16px); padding: 10px 20px; margin: 0 5px; }
        .logo { display: flex; align-items: center; flex-shrink: 0; order: 1; width: 100%; justify-content: center; margin-bottom: 20px; }
        .logo i { font-size: 40px; color: var(--primary-color); margin-right: 15px; }
        .header-title { text-align: center; margin-bottom: 30px; width: 100%; order: 0; }
        .app-container { display: flex; flex-direction: column; min-height: 70vh; overflow-x: hidden; }
        .page { display: none; animation: fadeIn 0.5s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .menu-categories { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; justify-content: flex-start; }
        .category-btn { padding: 10px 20px; background-color: #222; color: white; border: none; cursor: pointer; font-size: 16px; transition: all 0.3s; white-space: nowrap; min-width: 80px; text-align: center; touch-action: manipulation; }
        .category-btn.active { background-color: var(--primary-color); color: white; }
        .menu-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .menu-item { background-color: #1a1a1a; padding: 15px; transition: transform 0.3s; position: relative; }
        .menu-item:hover { transform: translateY(-5px); }
        .item-image { width: 100%; height: 200px; object-fit: cover; margin-bottom: 15px; border: 2px solid var(--primary-color); background-color: #333; background-size: cover; background-position: center; }
        .item-name { font-size: 20px; color: var(--primary-color); margin-bottom: 10px; }
        .item-description { color: #aaa; margin-bottom: 15px; font-size: 14px; line-height: 1.4; min-height: 40px; }
        .item-footer { display: flex; justify-content: space-between; align-items: center; }
        .item-price { font-size: 22px; font-weight: bold; color: white; }
        .add-to-cart { background-color: #333; color: white; border: none; padding: 8px 15px; cursor: pointer; font-size: 14px; transition: background-color 0.3s; touch-action: manipulation; }
        .add-to-cart:hover { background-color: var(--primary-color); }
        .instructions { padding: 20px; margin-top: 30px; margin-bottom: 30px; background-color: #1a1a1a; }
        .instructions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px; }
        .instruction-step { background-color: #222; padding: 15px; border-left: 4px solid var(--primary-color); }
        .instruction-step h4 { color: var(--primary-color); margin-bottom: 10px; font-size: 18px; }
        .qrcode-section { padding: 25px; background-color: #1a1a1a; text-align: center; margin-bottom: 40px; }
        .qrcode-section p { text-align: center; margin-bottom: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: clamp(14px, 2.5vw, 16px); padding: 0 10px; }
        .qrcode-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 30px; margin-top: 20px; }
        .qrcode-display { background-color: white; padding: 20px; border-radius: 8px; display: inline-block; width: 250px; height: 250px; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(0,0,0,0.2); position: relative; }
        .qrcode-info { max-width: 400px; text-align: center; }
        .qrcode-info h4 { color: var(--primary-color); margin-bottom: 15px; font-size: 20px; }
        .qrcode-info ul { padding-left: 0; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; }
        .qrcode-info li { margin-bottom: 10px; color: #aaa; list-style: none; display: flex; align-items: center; justify-content: center; gap: 10px; text-align: center; width: 100%; font-size: clamp(13px, 2vw, 15px); }
        .url-display { background-color: #222; padding: 12px; margin: 15px 0; border-left: 4px solid var(--primary-color); word-break: break-all; font-size: clamp(12px, 2vw, 14px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; }
        .qrcode-actions { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; width: 100%; }
        .qrcode-actions .pixel-button { flex: 1; min-width: 140px; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 10px 15px; font-size: 14px; }
        .admin-qrcode-section { margin-top: 40px; padding: 25px; background-color: #1a1a1a; }
        .admin-qrcode-section .qrcode-display { width: 300px; height: 300px; }
        .cart-container { position: fixed; bottom: 0; right: 0; width: 100%; max-width: 400px; background-color: #1a1a1a; border-top: 4px solid var(--primary-color); transform: translateY(100%); transition: transform 0.5s; z-index: 1000; max-height: 80vh; overflow-y: auto; overflow-x: hidden; touch-action: pan-y; }
        .cart-container.open { transform: translateY(0); }
        .cart-header { background-color: var(--primary-color); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .cart-header h3 { margin: 0; color: white; font-size: 20px; }
        .cart-tabs { display: flex; background-color: #222; }
        .cart-tab { flex: 1; padding: 12px; text-align: center; background-color: #333; color: white; border: none; cursor: pointer; font-size: 14px; transition: background-color 0.3s; touch-action: manipulation; }
        .cart-tab.active { background-color: var(--primary-color); font-weight: bold; }
        .cart-content { padding: 15px; }
        .cart-tab-content { display: none; }
        .cart-tab-content.active { display: block; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-name { font-weight: bold; }
        .cart-item-controls { display: flex; align-items: center; gap: 5px; }
        .cart-control-button { width: 35px; height: 35px; background-color: #000 !important; color: white !important; border: 2px solid white !important; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; user-select: none; touch-action: manipulation; }
        .cart-item-qty { min-width: 30px; text-align: center; color: white; font-size: 18px; font-weight: bold; }
        .cart-item-remove { margin-left: 10px; background: #d32f2f !important; color: white; border: none; cursor: pointer; padding: 5px 10px; font-size: 14px; }
        .cart-total { padding: 15px; background-color: #222; display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; margin-top: 20px; }
        .cart-toggle { position: fixed; bottom: 20px; right: 20px; width: 70px; height: 70px; border-radius: 50%; background-color: var(--primary-color); color: white; border: none; cursor: pointer; font-size: 24px; z-index: 999; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; touch-action: manipulation; }
        .order-history-item { background-color: #222; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary-color); }
        .admin-login { max-width: 400px; margin: 50px auto; padding: 30px; text-align: center; }
        .password-input { width: 100%; padding: 15px; margin: 20px 0; background-color: #222; border: 2px solid #444; color: white; font-size: 18px; text-align: center; }
        .admin-controls-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .admin-section { margin-bottom: 40px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--primary-color); font-weight: bold; }
        .form-input { width: 100%; padding: 12px; background-color: #222; border: 2px solid #444; color: white; font-size: 16px; }
        .image-upload-options { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .image-preview { width: 100%; max-height: 200px; object-fit: cover; margin-top: 10px; border: 2px solid #444; display: none; }
        .order-item { background-color: #222; padding: 15px; margin-bottom: 15px; border-left: 4px solid var(--primary-color); }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .order-number { word-break: break-all; overflow-wrap: break-word; line-height: 1.2; max-width: 100%; font-size: clamp(14px, 3.5vw, 18px); color: white !important; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .customer-phone-container { font-size: 18px; color: white !important; margin-top: 8px; display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; overflow: hidden; line-height: 1.2; white-space: nowrap; text-overflow: ellipsis; max-width: 100%; }
        .call-customer-btn { background-color: #2196f3 !important; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 5px; text-decoration: none; white-space: nowrap; flex-shrink: 0; height: 28px; }
        .order-actions { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 15px; align-items: center; }
        .order-actions .pixel-button { flex: 1; min-width: 80px; white-space: nowrap; padding: 6px 8px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; background-color: var(--primary-color); color: white; border-radius: 0; z-index: 1001; animation: slideIn 0.3s ease; display: none; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .connection-status { position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 4px; font-size: 12px; z-index: 1002; display: flex; align-items: center; gap: 5px; }
        .connection-status.online { background-color: var(--success-color); color: white; }
        .connection-status.offline { background-color: var(--error-color); color: white; }
        .connection-status.syncing { background-color: var(--warning-color); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; gap: 20px; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .sync-status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 4px; font-size: 12px; background-color: rgba(76, 175, 80, 0.1); color: #4caf50; margin-left: 10px; animation: pulse 2s infinite; }
        .new-order-notification { position: fixed; top: 80px; right: 20px; padding: 15px 20px; background-color: var(--success-color); color: white; border-radius: 0; z-index: 1001; animation: slideIn 0.3s ease; display: none; max-width: 300px; box-shadow: 0 0 20px rgba(0,0,0,0.3); cursor: pointer; }
        .phone-input { width: 100%; padding: 10px; background-color: #222; border: 2px solid #444; color: white; font-size: 14px; margin-top: 10px; }
        .phone-valid { border-color: #4caf50 !important; }
        .phone-invalid { border-color: #f44336 !important; animation: shake 0.5s; }
        @keyframes shake { 0%,100% { transform: translateX(0); } 10%,30%,50%,70%,90% { transform: translateX(-5px); } 20%,40%,60%,80% { transform: translateX(5px); } }
        .orders-controls { display: flex; flex-wrap: nowrap; gap: 8px; margin-bottom: 15px; align-items: center; width: 100%; overflow-x: auto; padding-bottom: 5px; }
        .orders-controls .pixel-button { flex: 0 1 auto; min-width: 100px; white-space: nowrap; flex-shrink: 0; }
        #ordersCount { white-space: nowrap; font-size: 14px; color: #aaa; margin-right: 15px; flex-shrink: 0; min-width: 80px; text-align: center; }
        .db-config-section { display: none !important; }
        .sound-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .upload-progress { width: 100%; height: 20px; background-color: #333; border-radius: 10px; overflow: hidden; margin: 10px 0; display: none; }
        .upload-progress-bar { height: 100%; background-color: #4caf50; width: 0%; transition: width 0.3s; }
        .sound-file-info { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .device-id-display { position: fixed; bottom: 10px; right: 10px; font-size: 10px; color: #666; z-index: 9999; }
        .lazy-image { opacity: 0; transition: opacity 0.3s ease; }
        .lazy-image.loaded { opacity: 1; }
        body.no-scroll { overflow: hidden; position: fixed; width: 100%; height: 100%; }
        @media (max-width: 768px) { .menu-items { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); } .cart-container { width: 100%; } .qrcode-display { width: 70vw; height: 70vw; max-width: 250px; max-height: 250px; } }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status offline"><i class="fas fa-wifi"></i><span>实时连接</span></div>
    <div id="newOrderNotification" class="new-order-notification pixel-border" style="display: none;"><i class="fas fa-bell"></i><span id="newOrderMessage">有新订单！</span></div>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;"><div class="loading"></div><p id="loadingMessage">正在初始化...</p></div>
    <div id="deviceIdDisplay" class="device-id-display"></div>
    <div class="container">
        <div class="header-title"><h1><i class="fas fa-cloud"></i> 云点餐系统</h1></div>
        <header>
            <div class="logo"><i class="fas fa-utensils"></i><div><h2 style="margin:0;">像素食堂</h2><p style="color:#aaa; margin:0;">云同步复古风格餐厅</p></div></div>
            <div class="header-controls">
                <button id="viewMenuBtn" class="pixel-button active">顾客点餐</button>
                <button id="viewAdminBtn" class="pixel-button secondary">管理后台</button>
                <button id="syncDataBtn" class="pixel-button success"><i class="fas fa-sync-alt"></i> 同步</button>
            </div>
        </header>
        <div class="app-container">
            <!-- 顾客点餐页面 -->
            <div id="menuPage" class="page active">
                <h2><i class="fas fa-book"></i> 菜单浏览</h2>
                <p style="color:#aaa; margin-bottom:20px;">数据实时同步更新</p>
                <div class="menu-categories">
                    <button class="category-btn pixel-border active" data-category="all">全部菜品</button>
                    <button class="category-btn pixel-border" data-category="main">主菜</button>
                    <button class="category-btn pixel-border" data-category="side">小食</button>
                    <button class="category-btn pixel-border" data-category="drink">饮品</button>
                    <button class="category-btn pixel-border" data-category="dessert">甜点</button>
                </div>
                <div class="menu-items" id="menuItemsContainer"></div>
                <div class="instructions pixel-border">
                    <h3><i class="fas fa-info-circle"></i> 使用说明</h3>
                    <div class="instructions-grid">
                        <div class="instruction-step"><h4>1. 实时连接</h4><p>所有数据云端存储，多设备实时同步更新</p></div>
                        <div class="instruction-step"><h4>2. 浏览菜品</h4><p>选择分类浏览菜单，点击加入购物车</p></div>
                        <div class="instruction-step"><h4>3. 查看购物车</h4><p>点击右下角购物车图标调整数量</p></div>
                        <div class="instruction-step"><h4>4. 提交订单</h4><p>确认订单后实时同步到厨房</p></div>
                    </div>
                </div>
                <div class="qrcode-section pixel-border">
                    <h3><i class="fas fa-mobile-alt"></i> 手机扫码点餐</h3>
                    <p>使用手机扫描下方二维码，可在手机上点餐</p>
                    <div class="qrcode-container">
                        <div class="qrcode-display pixel-border-white"><div id="customerQrCode" class="qrcode-canvas-container"></div></div>
                        <div class="qrcode-info">
                            <h4>云点餐优势</h4>
                            <ul>
                                <li><i class="fas fa-cloud"></i> <span>数据实时云端同步</span></li>
                                <li><i class="fas fa-mobile-alt"></i> <span>手机扫码直接点餐</span></li>
                                <li><i class="fas fa-bolt"></i> <span>订单实时推送到厨房</span></li>
                                <li><i class="fas fa-sync"></i> <span>多设备数据保持一致</span></li>
                                <li><i class="fas fa-shield-alt"></i> <span>企业级数据安全</span></li>
                            </ul>
                            <div class="url-display"><i class="fas fa-link"></i> 点餐网址: <span id="customerOrderUrl"></span></div>
                        </div>
                    </div>
                    <div class="qrcode-actions">
                        <button id="refreshQrCodeBtn" class="pixel-button secondary"><i class="fas fa-sync-alt"></i> 刷新二维码</button>
                        <button id="saveQrCodeBtn" class="pixel-button secondary"><i class="fas fa-download"></i> 保存二维码</button>
                    </div>
                </div>
            </div>
            <!-- 管理后台页面 -->
            <div id="adminPage" class="page">
                <div id="adminLogin" class="admin-login pixel-border">
                    <h2><i class="fas fa-lock"></i> 管理员登录</h2>
                    <p>请输入管理员密码进入后台</p>
                    <input type="password" id="adminPassword" class="password-input" placeholder="输入密码admin123">
                    <button id="loginBtn" class="pixel-button">登录</button>
                </div>
                <div id="adminPanel" style="display: none;">
                    <h2><i class="fas fa-cogs"></i> 云数据管理</h2>
                    <p style="color:#aaa; margin-bottom:20px;">数据实时同步，所有更改立即生效</p>
                    <div class="admin-controls-row">
                        <button id="addItemBtn" class="pixel-button active"><i class="fas fa-plus"></i> 新增菜品</button>
                        <button id="viewOrdersBtn" class="pixel-button secondary"><i class="fas fa-list"></i> 查看订单</button>
                        <button id="generateQrCodeBtn" class="pixel-button secondary"><i class="fas fa-qrcode"></i> 生成二维码</button>
                        <button id="manageConfigBtn" class="pixel-button secondary"><i class="fas fa-database"></i> 数据库配置</button>
                        <button id="logoutBtn" class="pixel-button warning"><i class="fas fa-sign-out-alt"></i> 退出登录</button>
                    </div>
                    <!-- 数据库配置管理（默认填充，自动检测连接） -->
                    <div id="configSection" class="admin-section pixel-border" style="display: none; padding: 20px;">
                        <h3><i class="fas fa-database"></i> 云数据库配置</h3>
                        <div style="background-color:#222; padding:20px; margin:20px 0;">
                            <h4 style="color:var(--primary-color); margin-bottom:15px;">当前配置状态</h4>
                            <div id="currentConfig" style="line-height:1.6;"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Supabase项目URL</label><input type="text" id="supabaseUrl" class="form-input" value="https://vtwhilxqztqmetorntid.supabase.co"></div>
                        <div class="form-group"><label class="form-label">Supabase匿名密钥</label><input type="text" id="supabaseAnonKey" class="form-input" value="sb_publishable_1NfB3o4x2kQnaLdwxygSBQ_yKMrIX9A"></div>
                        <div class="form-group"><label class="form-label">服务角色密钥（可选）</label><input type="text" id="supabaseServiceKey" class="form-input" value="sb_secret_xJxAqV-6Jllc4JbSXjEqhQ_L5yGYgCX"></div>
                        <div class="config-buttons-row" style="margin-top:20px; display:flex; gap:10px;">
                            <button id="testConnectionBtn" class="pixel-button"><i class="fas fa-plug"></i> 测试连接</button>
                            <button id="saveConfigBtn" class="pixel-button success"><i class="fas fa-save"></i> 保存配置</button>
                            <button id="resetConfigBtn" class="pixel-button secondary"><i class="fas fa-redo"></i> 重置</button>
                            <button id="closeConfigBtn" class="pixel-button secondary"><i class="fas fa-times"></i> 关闭</button>
                        </div>
                        <!-- 提示音设置区域精简展示（保留核心） -->
                        <div class="notification-sound-section" style="margin-top:30px;">
                            <h4><i class="fas fa-volume-up"></i> 新订单提示音</h4>
                            <div class="sound-controls">
                                <button id="testDefaultSoundBtn" class="pixel-button secondary">试听默认</button>
                                <button id="useDefaultSoundBtn" class="pixel-button success">使用默认</button>
                                <button id="selectCustomSoundBtn" class="pixel-button secondary"><i class="fas fa-upload"></i> 上传自定义</button>
                                <input type="file" id="customSoundUpload" accept="audio/*" style="display: none;">
                            </div>
                            <div id="uploadProgress" class="upload-progress"><div id="uploadProgressBar" class="upload-progress-bar"></div></div>
                            <div id="customSoundFileInfo" class="sound-file-info" style="display:none;"></div>
                            <div style="margin-top:10px;"><button id="muteNotificationsBtn" class="pixel-button warning">关闭提示音</button><button id="enableNotificationsBtn" class="pixel-button success" style="display:none;">开启提示音</button></div>
                        </div>
                    </div>
                    <!-- 菜品管理表单 -->
                    <div id="itemFormSection" class="admin-section pixel-border" style="padding:20px;">
                        <h3 id="formTitle">新增菜品</h3>
                        <form id="itemForm">
                            <input type="hidden" id="itemId">
                            <div class="form-group"><label class="form-label">菜品名称</label><input type="text" id="itemName" class="form-input" required></div>
                            <div class="form-group"><label class="form-label">分类</label><select id="itemCategory" class="form-input"><option value="main">主菜</option><option value="side">小食</option><option value="drink">饮品</option><option value="dessert">甜点</option></select></div>
                            <div class="form-group"><label class="form-label">价格 (元)</label><input type="number" id="itemPrice" class="form-input" min="0" step="0.01" required></div>
                            <div class="form-group"><label class="form-label">描述</label><textarea id="itemDescription" class="form-input" rows="3"></textarea></div>
                            <div class="form-group">
                                <label class="form-label">菜品图片</label>
                                <div class="image-upload-options"><button type="button" id="uploadImageBtn" class="pixel-button secondary"><i class="fas fa-upload"></i> 本地上传</button><button type="button" id="useUrlBtn" class="pixel-button secondary"><i class="fas fa-link"></i> 网络图片</button></div>
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                <input type="text" id="imageUrl" class="form-input" placeholder="输入图片URL" style="display: none; margin-top:10px;">
                                <img id="imagePreview" class="image-preview" alt="预览">
                            </div>
                            <div style="display:flex; gap:10px; margin-top:20px;"><button type="submit" class="pixel-button">保存到云端</button><button type="button" id="cancelEditBtn" class="pixel-button secondary">取消</button></div>
                        </form>
                    </div>
                    <!-- 菜品列表 -->
                    <div id="itemsListSection" class="admin-section">
                        <h3>云端菜品列表</h3>
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;"><span id="itemsCount" style="color:#aaa;">正在加载...</span><button id="refreshItemsBtn" class="pixel-button secondary"><i class="fas fa-sync-alt"></i> 刷新</button></div>
                        <div id="adminItemsContainer"></div>
                    </div>
                    <!-- 订单列表 -->
                    <div id="ordersSection" class="admin-section" style="display: none;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3><i class="fas fa-receipt"></i> 云端订单列表 <span class="sync-status-badge"><i class="fas fa-sync"></i> 实时连接</span></h3></div>
                        <div class="orders-controls"><span id="ordersCount" style="color:#aaa;">加载中...</span><button id="refreshOrdersBtn" class="pixel-button secondary"><i class="fas fa-sync-alt"></i> 刷新</button><button id="clearOrdersBtn" class="pixel-button warning"><i class="fas fa-trash"></i> 清空订单</button><button id="toggleAutoRefreshBtn" class="pixel-button success"><i class="fas fa-play"></i> 自动刷新</button></div>
                        <div id="ordersContainer" class="orders-list"></div>
                    </div>
                    <!-- 二维码生成区域 -->
                    <div id="qrcodeSection" class="admin-section admin-qrcode-section pixel-border" style="display: none;">
                        <h3><i class="fas fa-qrcode"></i> 点餐二维码生成</h3>
                        <p>生成顾客手机扫码点餐的二维码，可打印张贴</p>
                        <div class="form-group"><label class="form-label">点餐网址</label><input type="text" id="qrCodeUrl" class="form-input" readonly></div>
                        <div class="qrcode-preview-container"><div class="qrcode-display pixel-border-white"><div id="adminQrCode" class="qrcode-canvas-container"></div></div></div>
                        <div class="qrcode-actions"><button id="generateQrCodeNowBtn" class="pixel-button"><i class="fas fa-qrcode"></i> 生成二维码</button><button id="downloadQrCodeBtn" class="pixel-button secondary"><i class="fas fa-download"></i> 下载</button><button id="printQrCodeBtn" class="pixel-button secondary"><i class="fas fa-print"></i> 打印</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 购物车 -->
    <button id="cartToggle" class="cart-toggle"><i class="fas fa-shopping-cart"></i><span id="cartCount" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-size:14px;">0</span></button>
    <div id="cartContainer" class="cart-container pixel-border">
        <div class="cart-header"><h3>订单管理</h3><button id="closeCartBtn" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;"><i class="fas fa-times"></i></button></div>
        <div class="cart-tabs"><button class="cart-tab active" data-tab="current">当前订单</button><button class="cart-tab" data-tab="history">订单历史</button></div>
        <div class="cart-content">
            <div id="currentCartTab" class="cart-tab-content active">
                <div id="cartItemsContainer"></div>
                <div class="cart-total"><span>总计:</span><span id="cartTotal">0.00</span> 元</div>
                <div class="form-group" style="margin-top:15px;"><label class="form-label">联系电话（取餐联系）</label><input type="tel" id="customerPhone" class="phone-input" placeholder="请输入手机号码"><p style="color:#aaa; font-size:12px;">请输入11位手机号码</p></div>
                <div style="padding:15px 0;"><button id="submitOrderBtn" class="pixel-button" style="width:100%;">提交到订单</button></div>
            </div>
            <div id="historyCartTab" class="cart-tab-content"><div id="orderHistoryContainer" style="max-height:400px; overflow-y:auto;"></div></div>
        </div>
    </div>
    <div id="notification" class="notification pixel-border"><span id="notificationText"></span></div>
    <script>
        (function() {
            // ==================== 优化后的核心代码 ====================
            // 默认配置 (已填写)
            const DEFAULT_CONFIG = {
                supabaseUrl: 'https://vtwhilxqztqmetorntid.supabase.co',
                supabaseAnonKey: 'sb_publishable_1NfB3o4x2kQnaLdwxygSBQ_yKMrIX9A',
                supabaseServiceKey: 'sb_secret_xJxAqV-6Jllc4JbSXjEqhQ_L5yGYgCX'
            };
            const DEFAULT_IMAGE = 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=600';
            const ORDER_URL = window.location.origin + window.location.pathname;

            // 状态
            const state = {
                currentPage: 'menu',
                currentCategory: 'all',
                cart: [],
                orderHistory: [],
                menuItems: [],
                adminLoggedIn: false,
                supabaseClient: null,
                connectionStatus: 'offline',
                isOnline: navigator.onLine,
                deviceId: localStorage.getItem('pixel_device_id') || 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2,9),
                isNotificationMuted: false,
                audioContext: null,
                notificationSound: null,
                autoRefreshInterval: null,
                lastOrderCount: 0,
                realtimeSub: null,
                ordersRealtimeSub: null,
                systemRealtimeSub: null,
                cache: { menuItems: null, lastUpdated: 0, expires: 2*60*1000 }
            };
            localStorage.setItem('pixel_device_id', state.deviceId);
            document.getElementById('deviceIdDisplay').textContent = '设备: ' + state.deviceId.substr(0,8) + '...';

            // DOM 元素集合
            const els = {
                connectionStatus: document.getElementById('connectionStatus'),
                loadingOverlay: document.getElementById('loadingOverlay'),
                loadingMessage: document.getElementById('loadingMessage'),
                viewMenuBtn: document.getElementById('viewMenuBtn'),
                viewAdminBtn: document.getElementById('viewAdminBtn'),
                syncDataBtn: document.getElementById('syncDataBtn'),
                menuPage: document.getElementById('menuPage'),
                adminPage: document.getElementById('adminPage'),
                menuItemsContainer: document.getElementById('menuItemsContainer'),
                categoryBtns: document.querySelectorAll('.category-btn'),
                customerOrderUrl: document.getElementById('customerOrderUrl'),
                customerQrCode: document.getElementById('customerQrCode'),
                adminQrCode: document.getElementById('adminQrCode'),
                refreshQrCodeBtn: document.getElementById('refreshQrCodeBtn'),
                saveQrCodeBtn: document.getElementById('saveQrCodeBtn'),
                cartToggle: document.getElementById('cartToggle'),
                cartContainer: document.getElementById('cartContainer'),
                closeCartBtn: document.getElementById('closeCartBtn'),
                cartCount: document.getElementById('cartCount'),
                cartTotal: document.getElementById('cartTotal'),
                cartItemsContainer: document.getElementById('cartItemsContainer'),
                customerPhone: document.getElementById('customerPhone'),
                submitOrderBtn: document.getElementById('submitOrderBtn'),
                cartTabs: document.querySelectorAll('.cart-tab'),
                orderHistoryContainer: document.getElementById('orderHistoryContainer'),
                adminLogin: document.getElementById('adminLogin'),
                adminPassword: document.getElementById('adminPassword'),
                loginBtn: document.getElementById('loginBtn'),
                adminPanel: document.getElementById('adminPanel'),
                addItemBtn: document.getElementById('addItemBtn'),
                viewOrdersBtn: document.getElementById('viewOrdersBtn'),
                manageConfigBtn: document.getElementById('manageConfigBtn'),
                logoutBtn: document.getElementById('logoutBtn'),
                configSection: document.getElementById('configSection'),
                currentConfig: document.getElementById('currentConfig'),
                supabaseUrl: document.getElementById('supabaseUrl'),
                supabaseAnonKey: document.getElementById('supabaseAnonKey'),
                supabaseServiceKey: document.getElementById('supabaseServiceKey'),
                testConnectionBtn: document.getElementById('testConnectionBtn'),
                saveConfigBtn: document.getElementById('saveConfigBtn'),
                resetConfigBtn: document.getElementById('resetConfigBtn'),
                closeConfigBtn: document.getElementById('closeConfigBtn'),
                itemFormSection: document.getElementById('itemFormSection'),
                formTitle: document.getElementById('formTitle'),
                itemForm: document.getElementById('itemForm'),
                itemId: document.getElementById('itemId'),
                itemName: document.getElementById('itemName'),
                itemCategory: document.getElementById('itemCategory'),
                itemPrice: document.getElementById('itemPrice'),
                itemDescription: document.getElementById('itemDescription'),
                uploadImageBtn: document.getElementById('uploadImageBtn'),
                useUrlBtn: document.getElementById('useUrlBtn'),
                imageUpload: document.getElementById('imageUpload'),
                imageUrl: document.getElementById('imageUrl'),
                imagePreview: document.getElementById('imagePreview'),
                cancelEditBtn: document.getElementById('cancelEditBtn'),
                adminItemsContainer: document.getElementById('adminItemsContainer'),
                itemsCount: document.getElementById('itemsCount'),
                refreshItemsBtn: document.getElementById('refreshItemsBtn'),
                ordersSection: document.getElementById('ordersSection'),
                ordersContainer: document.getElementById('ordersContainer'),
                ordersCount: document.getElementById('ordersCount'),
                refreshOrdersBtn: document.getElementById('refreshOrdersBtn'),
                clearOrdersBtn: document.getElementById('clearOrdersBtn'),
                toggleAutoRefreshBtn: document.getElementById('toggleAutoRefreshBtn'),
                generateQrCodeBtn: document.getElementById('generateQrCodeBtn'),
                generateQrCodeNowBtn: document.getElementById('generateQrCodeNowBtn'),
                downloadQrCodeBtn: document.getElementById('downloadQrCodeBtn'),
                printQrCodeBtn: document.getElementById('printQrCodeBtn'),
                qrCodeUrl: document.getElementById('qrCodeUrl'),
                qrcodeSection: document.getElementById('qrcodeSection'),
                notification: document.getElementById('notification'),
                notificationText: document.getElementById('notificationText'),
                newOrderNotification: document.getElementById('newOrderNotification'),
                newOrderMessage: document.getElementById('newOrderMessage'),
                testDefaultSoundBtn: document.getElementById('testDefaultSoundBtn'),
                useDefaultSoundBtn: document.getElementById('useDefaultSoundBtn'),
                selectCustomSoundBtn: document.getElementById('selectCustomSoundBtn'),
                customSoundUpload: document.getElementById('customSoundUpload'),
                uploadProgress: document.getElementById('uploadProgress'),
                uploadProgressBar: document.getElementById('uploadProgressBar'),
                customSoundFileInfo: document.getElementById('customSoundFileInfo'),
                muteNotificationsBtn: document.getElementById('muteNotificationsBtn'),
                enableNotificationsBtn: document.getElementById('enableNotificationsBtn')
            };

            // ========== 辅助函数 ==========
            function showLoading(msg) { if(els.loadingOverlay) { els.loadingMessage.textContent = msg || '处理中...'; els.loadingOverlay.style.display = 'flex'; } }
            function hideLoading() { if(els.loadingOverlay) els.loadingOverlay.style.display = 'none'; }
            function showNotification(msg, type='info') {
                let bg = getComputedStyle(document.documentElement).getPropertyValue('--primary-color');
                if(type==='success') bg='#4caf50'; else if(type==='warning') bg='#ff9800'; else if(type==='error') bg='#f44336';
                els.notification.style.backgroundColor = bg;
                els.notificationText.textContent = msg;
                els.notification.style.display = 'block';
                setTimeout(()=> els.notification.style.display = 'none', 3000);
            }
            function updateConnectionStatus(status, text='实时连接') {
                els.connectionStatus.className = `connection-status ${status}`;
                els.connectionStatus.innerHTML = `<i class="fas ${status==='online'?'fa-wifi':status==='offline'?'fa-wifi-slash':'fa-sync fa-spin'}"></i><span>${text}</span>`;
                state.connectionStatus = status;
            }
            // 压缩图片 (任意格式/尺寸 -> 800px宽度, 质量0.7)
            async function compressImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width, height = img.height;
                            const maxWidth = 800;
                            if (width > maxWidth) { height = (height * maxWidth) / width; width = maxWidth; }
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); // 质量0.7
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // ========== Supabase初始化与实时订阅 ==========
            async function initSupabase() {
                const config = DEFAULT_CONFIG;
                try {
                    state.supabaseClient = supabase.createClient(config.supabaseUrl, config.supabaseAnonKey, {
                        auth: { autoRefreshToken: false, persistSession: false },
                        realtime: { params: { eventsPerSecond: 5 } }
                    });
                    // 快速测试连接
                    const { error } = await state.supabaseClient.from('menu_items').select('id').limit(1).maybeSingle();
                    if (error && error.code === 'PGRST116') {
                        // 表不存在，尝试创建默认数据（通过插入触发）
                        await createDefaultMenuItems();
                    } else if (error) throw error;
                    updateConnectionStatus('online');
                    setupRealtime();
                    await loadMenuItems(true); // 强制加载
                    showNotification('云端连接成功', 'success');
                } catch (e) {
                    console.warn('Supabase连接失败，使用本地缓存', e);
                    updateConnectionStatus('offline');
                    loadMenuItemsFromLocal();
                }
            }
            async function createDefaultMenuItems() {
                if (!state.supabaseClient) return;
                const defaultItems = [
                    { name:'像素汉堡', category:'main', price:28, description:'经典牛肉汉堡', image:'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=600' },
                    { name:'意式披萨', category:'main', price:45, description:'薄脆饼底', image:'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=600' },
                    { name:'复古薯条', category:'side', price:12, description:'香脆薯条', image:'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=600' },
                    { name:'像素可乐', category:'drink', price:8, description:'经典可乐', image:'https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=600' },
                    { name:'复古奶昔', category:'drink', price:18, description:'香草奶昔', image:'https://images.unsplash.com/photo-1572490122747-3968b75cc699?w=600' },
                    { name:'像素蛋糕', category:'dessert', price:22, description:'巧克力蛋糕', image:'https://images.unsplash.com/photo-1578985545062-69928b1d9587?w=600' }
                ];
                await state.supabaseClient.from('menu_items').insert(defaultItems).select();
            }
            function setupRealtime() {
                if (!state.supabaseClient) return;
                // 清理旧订阅
                if (state.realtimeSub) state.supabaseClient.removeChannel(state.realtimeSub);
                state.realtimeSub = state.supabaseClient.channel('menu_changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'menu_items' }, (payload) => {
                        console.log('菜单变化', payload);
                        loadMenuItems(true); // 强制刷新
                        if (state.adminLoggedIn) loadAdminItems();
                    })
                    .subscribe();
                if (state.ordersRealtimeSub) state.supabaseClient.removeChannel(state.ordersRealtimeSub);
                state.ordersRealtimeSub = state.supabaseClient.channel('orders_changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
                        if (payload.eventType === 'INSERT' && state.adminLoggedIn) {
                            if (!state.isNotificationMuted) playNotificationSound();
                            showNewOrderNotification(payload.new);
                        }
                        if (state.adminLoggedIn && els.ordersSection.style.display !== 'none') loadOrders();
                        // 更新本地历史订单
                        if (payload.new && payload.new.device_id === state.deviceId) {
                            updateLocalOrderHistory(payload.new);
                        }
                    })
                    .subscribe();
            }
            function updateLocalOrderHistory(order) {
                const idx = state.orderHistory.findIndex(o => o.id === order.id);
                if (idx > -1) state.orderHistory[idx] = order;
                else state.orderHistory.push(order);
                localStorage.setItem('order_history', JSON.stringify(state.orderHistory));
                if (els.cartContainer.classList.contains('open') && state.currentCartTab === 'history') loadOrderHistory();
            }
            // 菜单加载 (缓存+实时)
            async function loadMenuItems(forceRefresh = false) {
                const now = Date.now();
                if (!forceRefresh && state.cache.menuItems && (now - state.cache.lastUpdated < state.cache.expires)) {
                    state.menuItems = state.cache.menuItems;
                    renderMenuItems();
                    return;
                }
                if (state.supabaseClient && state.connectionStatus === 'online') {
                    try {
                        const { data, error } = await state.supabaseClient.from('menu_items').select('*').order('id');
                        if (!error && data) {
                            state.menuItems = data;
                            state.cache = { menuItems: data, lastUpdated: now };
                            localStorage.setItem('menu_cache', JSON.stringify(data));
                            renderMenuItems();
                            return;
                        }
                    } catch (e) { console.warn(e); }
                }
                loadMenuItemsFromLocal();
            }
            function loadMenuItemsFromLocal() {
                const cached = localStorage.getItem('menu_cache');
                state.menuItems = cached ? JSON.parse(cached) : [];
                renderMenuItems();
            }
            function renderMenuItems() {
                const container = els.menuItemsContainer;
                let filtered = state.menuItems.filter(i => state.currentCategory === 'all' || i.category === state.currentCategory);
                // 排序：主菜-小食-饮品-甜点
                const order = { main:1, side:2, drink:3, dessert:4 };
                filtered.sort((a,b) => (order[a.category]||99) - (order[b.category]||99));
                container.innerHTML = filtered.length ? '' : '<div class="empty-message"><p>暂无菜品</p></div>';
                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'menu-item pixel-border';
                    div.innerHTML = `
                        <img src="${item.image || DEFAULT_IMAGE}" alt="${item.name}" class="item-image lazy-image" onerror="this.src='${DEFAULT_IMAGE}'" loading="lazy">
                        <h3 class="item-name">${item.name}</h3>
                        <p class="item-description">${item.description || ''}</p>
                        <div class="item-footer"><div class="item-price">${item.price.toFixed(2)} 元</div><button class="add-to-cart pixel-border-white" data-id="${item.id}">加入购物车</button></div>
                    `;
                    container.appendChild(div);
                });
                // 懒加载
                document.querySelectorAll('.lazy-image').forEach(img => { img.classList.add('loaded'); });
                document.querySelectorAll('.add-to-cart').forEach(btn => btn.addEventListener('click', e => addToCart(parseInt(e.target.dataset.id))));
            }
            // 购物车操作
            function addToCart(id) {
                const item = state.menuItems.find(i => i.id == id);
                if (!item) return;
                const exist = state.cart.find(i => i.id == id);
                if (exist) exist.quantity++;
                else state.cart.push({ ...item, quantity:1 });
                updateCartUI();
                localStorage.setItem('cart', JSON.stringify(state.cart));
                showNotification(`已添加 ${item.name}`, 'success');
            }
            function updateCartUI() {
                const totalQty = state.cart.reduce((s,i)=>s+i.quantity,0);
                els.cartCount.textContent = totalQty;
                const totalPrice = state.cart.reduce((s,i)=>s+i.price*i.quantity,0);
                els.cartTotal.textContent = totalPrice.toFixed(2);
                if (!els.cartItemsContainer) return;
                els.cartItemsContainer.innerHTML = state.cart.length ? '' : '<div class="empty-message">购物车为空</div>';
                state.cart.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'cart-item';
                    row.innerHTML = `
                        <div class="cart-item-info"><div class="cart-item-name">${item.name}</div><div class="cart-item-price">${item.price.toFixed(2)}元</div></div>
                        <div class="cart-item-controls">
                            <button class="cart-control-button cart-item-decrease" data-id="${item.id}">-</button>
                            <span class="cart-item-qty">${item.quantity}</span>
                            <button class="cart-control-button cart-item-increase" data-id="${item.id}">+</button>
                            <button class="cart-item-remove" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    els.cartItemsContainer.appendChild(row);
                });
                // 绑定长按/点击事件
                document.querySelectorAll('.cart-item-decrease').forEach(b => bindCartButton(b, -1));
                document.querySelectorAll('.cart-item-increase').forEach(b => bindCartButton(b, 1));
                document.querySelectorAll('.cart-item-remove').forEach(b => b.addEventListener('click', e => {
                    const id = parseInt(e.target.closest('button').dataset.id);
                    state.cart = state.cart.filter(i => i.id !== id);
                    updateCartUI(); localStorage.setItem('cart', JSON.stringify(state.cart));
                }));
            }
            function bindCartButton(btn, delta) {
                let timer, interval;
                const clickHandler = () => {
                    const id = parseInt(btn.dataset.id);
                    const idx = state.cart.findIndex(i => i.id === id);
                    if (idx === -1) return;
                    state.cart[idx].quantity += delta;
                    if (state.cart[idx].quantity <= 0) state.cart.splice(idx,1);
                    updateCartUI(); localStorage.setItem('cart', JSON.stringify(state.cart));
                };
                btn.addEventListener('mousedown', e => { e.preventDefault(); clickHandler(); timer = setTimeout(() => { interval = setInterval(clickHandler, 100); }, 500); });
                btn.addEventListener('mouseup', () => { clearTimeout(timer); clearInterval(interval); });
                btn.addEventListener('mouseleave', () => { clearTimeout(timer); clearInterval(interval); });
                btn.addEventListener('touchstart', e => { e.preventDefault(); clickHandler(); timer = setTimeout(() => { interval = setInterval(clickHandler, 100); }, 500); });
                btn.addEventListener('touchend', () => { clearTimeout(timer); clearInterval(interval); });
                btn.addEventListener('touchcancel', () => { clearTimeout(timer); clearInterval(interval); });
            }
            // 提交订单 (手机号验证)
            async function submitOrder() {
                const phone = els.customerPhone.value.trim();
                if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
                    els.customerPhone.classList.add('phone-invalid');
                    if (!state.isNotificationMuted) playNotificationSound();
                    setTimeout(() => els.customerPhone.classList.remove('phone-invalid'), 1500);
                    showNotification('请输入有效的11位手机号', 'warning');
                    return;
                }
                if (state.cart.length === 0) { showNotification('购物车为空', 'warning'); return; }
                showLoading('提交订单中...');
                const order = {
                    order_number: 'ORD-' + Date.now(),
                    items: state.cart,
                    total: state.cart.reduce((s,i)=>s+i.price*i.quantity,0),
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    date: new Date().toLocaleString('zh-CN').replace(/\//g,'/'),
                    device_id: state.deviceId,
                    customer_phone: phone
                };
                try {
                    if (state.supabaseClient && state.connectionStatus === 'online') {
                        const { data, error } = await state.supabaseClient.from('orders').insert([order]).select();
                        if (error) throw error;
                        if (data && data[0]) order.id = data[0].id;
                    }
                    state.orderHistory.push(order);
                    localStorage.setItem('order_history', JSON.stringify(state.orderHistory));
                    state.cart = [];
                    updateCartUI();
                    localStorage.setItem('cart', JSON.stringify(state.cart));
                    els.customerPhone.value = '';
                    els.customerPhone.classList.remove('phone-valid');
                    switchCartTab('history');
                    showNotification('订单提交成功！', 'success');
                } catch (e) {
                    showNotification('订单提交失败，但已保存本地', 'error');
                    console.error(e);
                } finally { hideLoading(); }
            }
            // 提示音
            function playNotificationSound() {
                if (!state.audioContext) {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    if (!AudioCtx) return;
                    state.audioContext = new AudioCtx();
                }
                if (state.audioContext.state === 'suspended') state.audioContext.resume();
                const osc = state.audioContext.createOscillator();
                const gain = state.audioContext.createGain();
                osc.connect(gain); gain.connect(state.audioContext.destination);
                osc.frequency.value = 880; gain.gain.setValueAtTime(0.3, state.audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, state.audioContext.currentTime+0.3);
                osc.start(); osc.stop(state.audioContext.currentTime+0.3);
            }
            function showNewOrderNotification(order) {
                els.newOrderMessage.textContent = `新订单 #${order.id} ￥${order.total}`;
                els.newOrderNotification.style.display = 'block';
                setTimeout(() => els.newOrderNotification.style.display = 'none', 5000);
            }
            // 二维码
            function generateCustomerQrCode() {
                els.customerQrCode.innerHTML = '';
                new QRCode(els.customerQrCode, { text: ORDER_URL, width:180, height:180 });
            }
            // 页面切换
            function switchPage(page) {
                els.menuPage.classList.toggle('active', page==='menu');
                els.adminPage.classList.toggle('active', page==='admin');
                els.viewMenuBtn.classList.toggle('active', page==='menu');
                els.viewMenuBtn.classList.toggle('secondary', page!=='menu');
                els.viewAdminBtn.classList.toggle('active', page==='admin');
                els.viewAdminBtn.classList.toggle('secondary', page!=='admin');
                state.currentPage = page;
                if (page==='menu') loadMenuItems();
                else loadAdminPage();
            }
            function toggleCart() { els.cartContainer.classList.toggle('open'); }
            function switchCartTab(tab) {
                state.currentCartTab = tab;
                els.cartTabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
                document.getElementById('currentCartTab').classList.toggle('active', tab==='current');
                document.getElementById('historyCartTab').classList.toggle('active', tab==='history');
                if (tab==='history') loadOrderHistory();
            }
            function loadOrderHistory() {
                const myOrders = state.orderHistory.filter(o => o.device_id === state.deviceId).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
                els.orderHistoryContainer.innerHTML = myOrders.length ? '' : '<div class="empty-message">暂无历史订单</div>';
                myOrders.forEach(o => {
                    const div = document.createElement('div');
                    div.className = 'order-history-item';
                    div.innerHTML = `<div><strong>订单 #${o.id}</strong> <span class="order-status ${o.status==='processed'?'processed':''}">${o.status==='processed'?'已处理':'待处理'}</span><div>${o.date}</div><div>电话:${o.customer_phone}</div>`;
                    els.orderHistoryContainer.appendChild(div);
                });
            }
            // 管理后台
            function adminLogin() {
                if (els.adminPassword.value === 'admin123') {
                    state.adminLoggedIn = true;
                    els.adminLogin.style.display = 'none';
                    els.adminPanel.style.display = 'block';
                    loadAdminItems();
                    showNotification('登录成功', 'success');
                } else showNotification('密码错误', 'error');
            }
            function adminLogout() { state.adminLoggedIn = false; els.adminLogin.style.display = 'block'; els.adminPanel.style.display = 'none'; }
            async function loadAdminItems() {
                await loadMenuItems(true);
                els.adminItemsContainer.innerHTML = '';
                const cats = { main:'主菜', side:'小食', drink:'饮品', dessert:'甜点' };
                for (let cat of ['main','side','drink','dessert']) {
                    const items = state.menuItems.filter(i => i.category === cat);
                    if (!items.length) continue;
                    let html = `<h4 style="margin:20px 0 10px; color:var(--primary-color);">${cats[cat]}</h4><div class="admin-items-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:15px;">`;
                    items.forEach(item => {
                        html += `<div class="admin-item pixel-border" style="padding:15px; background:#222; display:flex; align-items:center;">
                            <img src="${item.image||DEFAULT_IMAGE}" style="width:60px; height:60px; object-fit:cover; margin-right:15px;" onerror="this.src='${DEFAULT_IMAGE}'">
                            <div style="flex:1;"><div style="font-weight:bold;">${item.name}</div><div>￥${item.price}</div></div>
                            <div><button class="edit-item pixel-border-white" data-id="${item.id}">编辑</button><button class="delete-item pixel-border-white" data-id="${item.id}" style="background:#d32f2f;">删除</button></div>
                        </div>`;
                    });
                    html += '</div>';
                    els.adminItemsContainer.insertAdjacentHTML('beforeend', html);
                }
                els.itemsCount.textContent = `共 ${state.menuItems.length} 个菜品`;
                document.querySelectorAll('.edit-item').forEach(b => b.addEventListener('click', e => editItem(parseInt(e.target.dataset.id))));
                document.querySelectorAll('.delete-item').forEach(b => b.addEventListener('click', e => deleteItem(parseInt(e.target.dataset.id))));
            }
            function showAddItemForm() {
                els.itemForm.reset(); els.itemId.value = ''; els.formTitle.textContent = '新增菜品';
                els.imagePreview.style.display = 'none'; els.imageUrl.style.display = 'none'; els.imageUrl.value = '';
                els.itemFormSection.style.display = 'block'; els.ordersSection.style.display = 'none'; els.qrcodeSection.style.display = 'none'; els.configSection.style.display = 'none';
            }
            async function saveMenuItem(e) {
                e.preventDefault();
                const name = els.itemName.value.trim(), category = els.itemCategory.value, price = parseFloat(els.itemPrice.value);
                if (!name || isNaN(price) || price<=0) { showNotification('请完整填写', 'warning'); return; }
                let image = DEFAULT_IMAGE;
                if (els.imageUpload.files[0]) {
                    try { image = await compressImage(els.imageUpload.files[0]); }
                    catch(err) { showNotification('图片压缩失败', 'error'); return; }
                } else if (els.imageUrl.value.trim()) image = els.imageUrl.value.trim();
                const itemData = { name, category, price, description: els.itemDescription.value.trim(), image };
                showLoading('保存中...');
                try {
                    if (els.itemId.value) { // 编辑
                        if (state.supabaseClient && state.connectionStatus==='online')
                            await state.supabaseClient.from('menu_items').update(itemData).eq('id', els.itemId.value);
                    } else {
                        if (state.supabaseClient && state.connectionStatus==='online')
                            await state.supabaseClient.from('menu_items').insert([itemData]);
                    }
                    await loadMenuItems(true);
                    await loadAdminItems();
                    showNotification('保存成功', 'success');
                    els.itemForm.reset();
                    els.imagePreview.style.display = 'none';
                } catch (err) { showNotification('保存失败: ' + err.message, 'error'); } finally { hideLoading(); }
            }
            function editItem(id) {
                const item = state.menuItems.find(i => i.id == id);
                if (!item) return;
                els.itemId.value = item.id;
                els.itemName.value = item.name;
                els.itemCategory.value = item.category;
                els.itemPrice.value = item.price;
                els.itemDescription.value = item.description || '';
                els.imagePreview.src = item.image || DEFAULT_IMAGE;
                els.imagePreview.style.display = 'block';
                els.imageUrl.value = item.image || '';
                els.formTitle.textContent = '编辑菜品';
                els.itemFormSection.style.display = 'block';
                els.ordersSection.style.display = 'none';
                els.qrcodeSection.style.display = 'none';
                els.configSection.style.display = 'none';
            }
            async function deleteItem(id) {
                if (!confirm('确定删除？')) return;
                showLoading('删除中...');
                try {
                    if (state.supabaseClient && state.connectionStatus==='online')
                        await state.supabaseClient.from('menu_items').delete().eq('id', id);
                    await loadMenuItems(true);
                    await loadAdminItems();
                    showNotification('已删除', 'success');
                } catch (err) { showNotification('删除失败', 'error'); } finally { hideLoading(); }
            }
            async function loadOrders() {
                if (!state.supabaseClient || state.connectionStatus !== 'online') { els.ordersContainer.innerHTML = '<div class="empty-message">离线模式，无法加载订单</div>'; return; }
                const { data, error } = await state.supabaseClient.from('orders').select('*').order('created_at', { ascending: false }).limit(100);
                if (error) return;
                els.ordersContainer.innerHTML = '';
                if (!data.length) { els.ordersContainer.innerHTML = '<div class="empty-message">暂无订单</div>'; return; }
                data.forEach(order => {
                    const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
                    const total = order.total || items.reduce((s,i)=>s+i.price*i.quantity,0);
                    const div = document.createElement('div');
                    div.className = 'order-item';
                    div.innerHTML = `
                        <div class="order-header"><div><div class="order-number">#${order.id}</div><div>${order.date||order.created_at}</div><div class="customer-phone-container"><i class="fas fa-phone"></i> ${order.customer_phone||'无'}</div></div>
                        <div><span class="order-status ${order.status==='processed'?'processed':''}">${order.status==='processed'?'已处理':'待处理'}</span><div style="font-size:20px; font-weight:bold;">￥${total.toFixed(2)}</div></div></div>
                        <div class="order-actions"><button class="mark-processed pixel-button" data-id="${order.id}">标记已处理</button><button class="delete-order pixel-button secondary" data-id="${order.id}">删除</button><button class="print-order pixel-button print-order-btn" data-id="${order.id}">打印</button></div>
                    `;
                    els.ordersContainer.appendChild(div);
                });
                document.querySelectorAll('.mark-processed').forEach(b => b.addEventListener('click', async e => {
                    const id = e.target.dataset.id;
                    await state.supabaseClient.from('orders').update({ status:'processed', updated_at:new Date().toISOString() }).eq('id', id);
                    loadOrders();
                }));
                document.querySelectorAll('.delete-order').forEach(b => b.addEventListener('click', async e => {
                    if (!confirm('删除订单？')) return;
                    const id = e.target.dataset.id;
                    await state.supabaseClient.from('orders').delete().eq('id', id);
                    loadOrders();
                }));
            }
            function toggleOrdersView() {
                els.ordersSection.style.display = 'block';
                els.itemFormSection.style.display = 'none';
                els.qrcodeSection.style.display = 'none';
                els.configSection.style.display = 'none';
                loadOrders();
                startAutoRefresh();
            }
            function startAutoRefresh() {
                if (state.autoRefreshInterval) clearInterval(state.autoRefreshInterval);
                state.autoRefreshInterval = setInterval(() => { if (els.ordersSection.style.display !== 'none') loadOrders(); }, 2000);
            }
            // 初始化
            async function init() {
                // 加载本地数据
                const cart = localStorage.getItem('cart'); if (cart) state.cart = JSON.parse(cart);
                const history = localStorage.getItem('order_history'); if (history) state.orderHistory = JSON.parse(history);
                updateCartUI();
                // 设置监听
                els.viewMenuBtn.addEventListener('click', ()=>switchPage('menu'));
                els.viewAdminBtn.addEventListener('click', ()=>switchPage('admin'));
                els.syncDataBtn.addEventListener('click', async ()=>{
                    showLoading('同步中...');
                    await initSupabase();
                    await loadMenuItems(true);
                    if (state.adminLoggedIn) await loadAdminItems();
                    hideLoading();
                    showNotification('同步完成', 'success');
                });
                els.categoryBtns.forEach(btn => btn.addEventListener('click', function(){
                    els.categoryBtns.forEach(b=>b.classList.remove('active'));
                    this.classList.add('active');
                    state.currentCategory = this.dataset.category;
                    renderMenuItems();
                }));
                els.cartToggle.addEventListener('click', toggleCart);
                els.closeCartBtn.addEventListener('click', toggleCart);
                els.submitOrderBtn.addEventListener('click', submitOrder);
                els.cartTabs.forEach(tab => tab.addEventListener('click', ()=>switchCartTab(tab.dataset.tab)));
                els.loginBtn.addEventListener('click', adminLogin);
                els.logoutBtn.addEventListener('click', adminLogout);
                els.addItemBtn.addEventListener('click', showAddItemForm);
                els.viewOrdersBtn.addEventListener('click', toggleOrdersView);
                els.manageConfigBtn.addEventListener('click', ()=>{
                    els.configSection.style.display = 'block';
                    els.itemFormSection.style.display = 'none';
                    els.ordersSection.style.display = 'none';
                    els.qrcodeSection.style.display = 'none';
                    let html = `<p><strong>当前配置:</strong> 已配置 <span style="color:#4caf50;">online</span></p><p><strong>URL:</strong> ${DEFAULT_CONFIG.supabaseUrl}</p><p><strong>连接状态:</strong> ${state.connectionStatus}</p>`;
                    els.currentConfig.innerHTML = html;
                });
                els.closeConfigBtn.addEventListener('click', ()=> els.configSection.style.display = 'none');
                els.testConnectionBtn.addEventListener('click', async ()=>{
                    showLoading('测试连接');
                    await initSupabase();
                    hideLoading();
                });
                els.saveConfigBtn.addEventListener('click', async ()=>{
                    showLoading('保存配置');
                    await initSupabase();
                    hideLoading();
                });
                els.resetConfigBtn.addEventListener('click', ()=>{ location.reload(); });
                els.generateQrCodeBtn.addEventListener('click', ()=>{
                    els.qrcodeSection.style.display = 'block';
                    els.itemFormSection.style.display = 'none';
                    els.ordersSection.style.display = 'none';
                    els.configSection.style.display = 'none';
                    generateAdminQrCode();
                });
                els.generateQrCodeNowBtn.addEventListener('click', generateAdminQrCode);
                els.downloadQrCodeBtn.addEventListener('click', ()=>{
                    const img = els.adminQrCode.querySelector('img');
                    if (img) { const a = document.createElement('a'); a.href = img.src; a.download = 'qrcode.png'; a.click(); }
                });
                els.printQrCodeBtn.addEventListener('click', ()=>{ window.print(); });
                els.refreshQrCodeBtn.addEventListener('click', generateCustomerQrCode);
                els.saveQrCodeBtn.addEventListener('click', ()=>{
                    const img = els.customerQrCode.querySelector('img');
                    if (img) { const a = document.createElement('a'); a.href = img.src; a.download = 'menu_qrcode.png'; a.click(); }
                });
                els.itemForm.addEventListener('submit', saveMenuItem);
                els.cancelEditBtn.addEventListener('click', ()=> els.itemForm.reset());
                els.uploadImageBtn.addEventListener('click', ()=> els.imageUpload.click());
                els.useUrlBtn.addEventListener('click', ()=> { els.imageUrl.style.display = 'block'; els.imageUpload.style.display = 'none'; });
                els.imageUpload.addEventListener('change', e => {
                    if (e.target.files[0]) {
                        const url = URL.createObjectURL(e.target.files[0]);
                        els.imagePreview.src = url; els.imagePreview.style.display = 'block';
                    }
                });
                els.imageUrl.addEventListener('input', ()=> { els.imagePreview.src = els.imageUrl.value; els.imagePreview.style.display = 'block'; });
                els.refreshItemsBtn.addEventListener('click', ()=> loadAdminItems());
                els.clearOrdersBtn.addEventListener('click', async ()=>{
                    if (!confirm('清空所有订单？')) return;
                    if (state.supabaseClient) await state.supabaseClient.from('orders').delete().neq('id',0);
                    loadOrders();
                });
                // 提示音
                els.testDefaultSoundBtn.addEventListener('click', playNotificationSound);
                els.useDefaultSoundBtn.addEventListener('click', ()=>{ state.isNotificationMuted = false; showNotification('已使用默认提示音', 'info'); });
                els.selectCustomSoundBtn.addEventListener('click', ()=> els.customSoundUpload.click());
                els.customSoundUpload.addEventListener('change', async (e)=>{
                    const file = e.target.files[0];
                    if (!file) return;
                    // 任意格式，直接上传为base64（但为了不超长，依然压缩为短音频？但大小限制由服务器，这里只做演示，实际可上传到存储，此处简化）
                    showNotification('自定义提示音上传功能演示，实际应上传至云存储', 'info');
                });
                els.muteNotificationsBtn.addEventListener('click', ()=>{ state.isNotificationMuted = true; els.muteNotificationsBtn.style.display='none'; els.enableNotificationsBtn.style.display='inline-block'; });
                els.enableNotificationsBtn.addEventListener('click', ()=>{ state.isNotificationMuted = false; els.enableNotificationsBtn.style.display='none'; els.muteNotificationsBtn.style.display='inline-block'; });
                // 初始化二维码
                els.customerOrderUrl.textContent = ORDER_URL;
                els.qrCodeUrl.value = ORDER_URL;
                generateCustomerQrCode();
                generateAdminQrCode();
                // 连接Supabase
                await initSupabase();
                // 加载菜单
                await loadMenuItems();
            }
            function generateAdminQrCode() {
                els.adminQrCode.innerHTML = '';
                new QRCode(els.adminQrCode, { text: ORDER_URL, width:220, height:220 });
            }
            function loadAdminPage() {
                if (state.adminLoggedIn) { els.adminLogin.style.display = 'none'; els.adminPanel.style.display = 'block'; loadAdminItems(); }
                else { els.adminLogin.style.display = 'block'; els.adminPanel.style.display = 'none'; }
            }
            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>